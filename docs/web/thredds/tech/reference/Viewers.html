<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>TDS Viewer Links</title>
</head>

<body>
<h1><img src="../images/unidataLogo.png" width="75" height="75" align="middle">Adding Viewer Links</h1>
<hr>
<p>The TDS adds <em><strong>Viewer Links</strong></em> to datasets at the bottom of a dataset's HTML web page, for example:</p>
<p><img src="../images/StaticViewer.jpg" alt="Viewers" width="573" height="488" border="2"></p>
<p>Currently, the TDS automatically adds a NetCDF-Java Tools link to any direct dataset that has an ID. It adds an IDV link to any dataset that has an OPENDAP service, and has a DataType of <em>GRID</em>.</p>
<p>You can add your own viewer links in these ways:</p>
<ol>
  <li>Adding a property element to each dataset, explicitly listing the URL of the viewer</li>
  <li>Creating a Java class that tells the TDS what datasets are viewable, and what HTML fragment to include. </li>
</ol>
<h2>Adding a property element </h2>
<p>This method is available in TDS version 3.17+.</p>
<h3>Adding a static viewer link</h3>
<p>To add a viewer link to a specific dataset, add a property element to the dataset in the configuration file, for example:</p>
<pre>  &lt;dataset name=&quot;Test Viewer&quot; ID=&quot;testViewer&quot; serviceName=&quot;dapService&quot; urlPath=&quot;test/testData.nc&quot; dataType=&quot;Grid&quot;&gt;<br>    <strong>&lt;property name=&quot;viewer&quot; value=&quot;http://www.unidata.ucar.edu/staff/caron/,MyViewer&quot;/&gt;</strong><br>  &lt;/dataset&gt;</pre>
<p>  The name of the property must be <strong>&quot;viewer&quot;</strong>and the value must be the viewer link, a comma, and then the viewer name. The actual HTML fragment that is placed into the web page is<br>
</p>
<pre>    &lt;a href='&quot;+<strong>viewerLink</strong>+&quot;'&gt;&quot;+<strong>viewerName</strong>+&quot;&lt;/a&gt;<br>


</pre>
<h3>Using inheritence to add viewer links to many datasets</h3>
<p>By placing the property in an inherited metadata element, one can make it appear on all children of the dataset. This is espcially useful in conjuction with the datasetScan element. For example:</p>
<pre>&lt;datasetScan name=&quot;Test all files in a directory&quot; ID=&quot;testDatasetScan&quot; path=&quot;testAll&quot; location=&quot;content/testdata&quot;&gt;
<strong>  &lt;metadata inherited=&quot;true&quot;&gt;</strong>
    &lt;serviceName&gt;allServices&lt;/serviceName&gt;
    &lt;dataType&gt;Grid&lt;/dataType&gt;    <strong>
    &lt;property name=&quot;viewer&quot; value=&quot;http://www.unidata.ucar.edu/staff/caron/,MyViewer&quot;/&gt;</strong><br>  &lt;/metadata&gt;
&lt;/datasetScan&gt;</pre>
<h3>Adding the Dataset URL to the Viewer Link</h3>
<p>You may need to include the dataset URL into the viewer link. If there is a single service for the dataset, you can place &quot;<strong>{url}</strong>&quot; into your viewer link, and the Dataset's access URL will be substituted for it:</p>
<pre>  &lt;dataset name=&quot;Test Viewer2&quot; ID=&quot;testViewer2&quot; serviceName=&quot;dapService&quot; urlPath=&quot;test/testData.nc&quot; dataType=&quot;Grid&quot;<br>    &lt;property name=&quot;viewer&quot; value=&quot;http://localhost:8080/thredds/cdmValidate?URL=<strong>{url}</strong>,Validation Service&quot;/&gt;<br>  &lt;/dataset&gt;<br></pre>
<p>will create a URL like:</p>
<pre>  http://localhost:8080/thredds/cdmValidate?URL=http://localhost:8080/thredds/dodsC/test/testData.nc
 </pre>
<h3>Selecting one of the Dataset access URLs</h3>
<p>When a Dataset has more than one kind of access, each access will have a seperate URL. Use the service name inside of curly brackets to select which access URL to use: </p>
<pre>&lt;datasetScan name=&quot;Test all files in a directory&quot; ID=&quot;testDatasetScan&quot; path=&quot;testAll&quot; location=&quot;content/testdata&quot;&gt;
  &lt;metadata inherited=&quot;true&quot;&gt;
    &lt;serviceName&gt;allServices&lt;/serviceName&gt;
    &lt;dataType&gt;Grid&lt;/dataType&gt;    
    &lt;property name=&quot;viewer&quot; value=&quot;http://localhost:8080/thredds/cdmValidate?URL=<strong>{HTTPService}</strong>,Validation Service&quot;/&gt;<br>  &lt;/metadata&gt;
&lt;/datasetScan&gt;

</pre>
<hr>
<br>
<h2>Create a  Viewer implementation Java class </h2>
<p>This method is available in TDS version 3.14+.</p>
<p>This technique gives you full control over whether your viewer link appears, and what the URL looks like. You must create a Java  class which implements the <strong>thredds.servlet.Viewer</strong> interface: </p>
<pre>public interface <strong>Viewer</strong> {
<strong> (1)</strong> public boolean <strong>isViewable</strong>( thredds.catalog.InvDatasetImpl dataset);
<strong> (2)</strong> public String <strong>getViewerLinkHtml</strong>( InvDatasetImpl ds, HttpServletRequest req);
}</pre>
<ol>
  <li>  Your class is passed a <strong>thredds.catalog.InvDatasetImpl</strong> object, and it  returns true if it is viewable by your viewer.</li>
  <li>Your class is passed a viewable <strong>thredds.catalog.InvDatasetImpl</strong>, and it must return a well-formed HTML string that has an <em><strong>href</strong></em> link in it.</li>
</ol>
<p><strong>Example</strong>:</p>
<pre>package my.package;
include thredds.catalog.*;


public class IDV implements Viewer {</pre>
<pre> public boolean <strong>isViewable</strong>( InvDatasetImpl ds) {
   InvAccess access = ds.getAccess(ServiceType.DODS);
   if (access == null) access = ds.getAccess(ServiceType.OPENDAP);
<strong>1)</strong> if (access == null) return false;

<strong>2)</strong> return (ds.getDataType() == DataType.GRID);
 }</pre>
<pre> public String <strong>getViewerLinkHtml</strong>( InvDatasetImpl ds, HttpServletRequest req) {
   InvAccess access = ds.getAccess(ServiceType.DODS);
<strong>3)</strong> if (access == null) access = ds.getAccess(ServiceType.OPENDAP);</pre>
<pre><strong>4)</strong> URI dataURI = access.getStandardUri();
   try {
     URI base = new URI( req.getRequestURL().toString());
<strong>5)</strong>   dataURI = base.resolve( dataURI);
   } catch (URISyntaxException e) {
     log.error(&quot;Resolve URL with &quot;+req.getRequestURL(),e);
   }
</pre>
<pre><strong>6)</strong> return &quot;&lt;a href='<strong>/thredds/view/idv.jnlp</strong>?url=&quot;+dataURI.toString()+&quot;'&gt;Integrated Data Viewer (IDV) (webstart)&lt;/a&gt;&quot;;
 }
</pre>
<ol>
  <li>Requires there to be  OPeNDAP access for the dataset. </li>
  <li>Requires the dataset to be of <strong>DataType.GRID</strong>. </li>
  <li>Get the OPeNDAP access object for the dataset.</li>
  <li>Get the access URI.</li>
  <li>Resolves the access URI against the request, which turns it into an absolute URI</li>
  <li> Forms the HTML string to be placed on the dataset's TDS web page. Note that is has an href embedded in it, which will be displayed in this example as:
  </pre>
  </pre>
  <blockquote>
    <p><a href="http://motherlode.ucar.edu:8080/thredds/view/idv.jnlp?url=http://motherlode.ucar.edu:8080/thredds/dodsC/model/NCEP/NDFD/CONUS_5km/NDFD_CONUS_5km_20061106_1200.grib2">Integrated Data Viewer (IDV) (webstart)</a></p>
    </blockquote>
  </li>
</ol>
<h3>Referencing an external URL</h3>
<p>If the viewer you want to reference is not part of the TDS, just make the href  absolute, eg:</p>
<pre> &lt;a href='http://my.server/viewer?<strong>url=http://motherlode.ucar.edu:8080/thredds/dodsC/model/data.grib2</strong>'&gt;My Server&lt;/a&gt;</pre>
<p>In this example, the server would see the OPeNDAP data access URL and remotely read it.</p>
<h3>Returning a JNLP file </h3>
<p>The IDV example returns a JNLP file, which allows the IDV client program to be automatically started through <a href="http://java.sun.com/products/javawebstart/">Java Webstart</a>. If you have a webstart-enabled viewer, you can also get the TDS to return  your own JNLP file. To do so:</p>
<ol>
  <li>The returned URL should start with <strong>/thredds/view</strong>/</li>
  <li>The remaining part of the URL (before the ?) is the name of a <em><strong>JNLP template file</strong></em> in the <strong>${tomcat_home}/content/thredds/views/</strong> directory.</li>
  <li>The JNLP template file is processed in the following way:
    <ol>
      <li>Each parameter in the URL is read as a <em>name=value</em> pair (in the example, there is one parameter, whose name is <strong>url</strong> and value is <strong>http://motherlode.ucar.edu:8080/thredds/dodsC/model/data.grib2).</strong></li>
      <li>The  JNLP template file is searched for strings of the form <em><strong>{name}</strong></em>, and the corresponding value is substituted into it (in the example, all strings of the form <strong>{url}</strong> would be replaced by <strong>http://motherlode.ucar.edu:8080/thredds/dodsC/model/data.grib2).</strong></li>
    </ol>
  </li>
  <li>Once the JNLP template file is processed, it is sent as the response to the user clicking on your  link. If they have webstart installed, the application named in the JNLP file is downloaded (if necessary) and started up. </li>
</ol>
<p><strong>Example</strong>:</p>
<p>This is an approximately what is used in the IDV JNLP file. Note that the {url} string on the boldface line is replaced by the actual data access URL. This will create a command line argument  <strong>-data type:opendap.grid:http://motherlode.ucar.edu:8080/thredds/dodsC/model/data.grib2 </strong>and pass it to the IDV application. </p>
<pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;<br>&lt;!-- JNLP File for Integrated Data Viewer --&gt;<br>&lt;jnlp spec=&quot;1.0+&quot; codebase=&quot;http://www.unidata.ucar.edu/software/idv/webstart/&quot;&gt;<br>  &lt;information&gt;<br>    &lt;title&gt;Integrated Data Viewer&lt;/title&gt;<br>    &lt;vendor&gt;Unidata&lt;/vendor&gt;<br>    &lt;homepage href=&quot;http://www.unidata.ucar.edu/software/idv/index.html&quot;/&gt;<br>    &lt;description&gt;Integrated Data Viewer(IDV)&lt;/description&gt;<br>    &lt;description kind=&quot;short&quot;&gt;A tool for geoscientific analysis and visualization.<br>    &lt;/description&gt;<br>    &lt;icon href=&quot;IDV/idv.gif&quot;/&gt;<br>    &lt;offline-allowed/&gt;<br>  &lt;/information&gt;</pre>
<pre>  &lt;security&gt;
   &lt;all-permissions/&gt;
  &lt;/security&gt;</pre>
<pre>  &lt;resources&gt;
   &lt;j2se version=&quot;1.4+&quot; max-heap-size=&quot;512m&quot;/&gt;
   &lt;jar href=&quot;IDV/idv.jar&quot;/&gt;
   &lt;extension name=&quot;IDV Base&quot; href=&quot;IDV/idvbase.jnlp&quot;/&gt;
  &lt;/resources&gt;
  &lt;application-desc main-class=&quot;ucar.unidata.idv.DefaultIdv&quot;&gt;
   &lt;argument&gt;-data&lt;/argument&gt;
   <strong>&lt;argument&gt;type:opendap.grid:{url}&lt;/argument&gt;</strong>
  &lt;/application-desc&gt;</pre>
<pre>&lt;/jnlp&gt;</pre>
<h3>  Loading your class at runtime</h3>
<p>You must place your Viewer class into  <strong>the ${tomcat_home}/webapps/thredds/WEB-INF/lib </strong>or<strong> classes </strong>directory<strong>. </strong>(Previous instructions to place it into  the <strong>${tomcat_home}/shared</strong> directory doesn't work, because of classloader problems). </p>
<p>Then tell the TDS to load it by adding a line to the <strong>${tomcat_home}/content/thredds/threddsConfig.xml</strong> file, for example:</p>
<pre>  &lt;viewer&gt;my.package.MyViewer&lt;/viewer&gt;</pre>
<hr width="100%">
<strong><br>
</strong>
<address>
<img src="../images/thread.png" width="110" height="108">This document is maintained by <a href="mailto:caron@unidata.ucar.edu">John Caron</a> and was last updated on Oct 23, 2008
</address>
<p>&nbsp;</p>
</body>
</html>
