<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <link rel="stylesheet" href="../tds.css" type="text/css">

  <title>TDS FAQ</title>
</head>
<body>

<h1><img src="../images/unidataLogo.png" alt="Unidata" align="middle" height="75" width="75">THREDDS Data Server (TDS) FAQ</h1>

<hr width="100%">

<h2>Catalogs</h2>
<ul>
  <li><a href="#CatalogURLs">How do I construct the URLs I find in a THREDDS Catalog? </a></li>
</ul>
<h2>TDS</h2>
<ul>
  <li><a href="#throttleRequests">How do I keep client requests from overwhelming my server?</a></li>
  <li><a href="#tooManyFilesOpen">Can aggregations of many files cause "too many files open" problems?</a></li>
  <li><a href="#nonHttpStatusCodes">What do the non-HTTP status codes in the <code>threddsServlet.log</code> files mean?</a></li>
  <li><a href="#inconsistentArrayLength">I'm seeing the error "Inconsistent array length read: 538976288 !=  1668244581' when I open the dataset in the IDV. Why?</a></li>
  <li><a href="#javaUtilPrefs">Why am I getting lots of
    <code>java.util.prefs.BackingStoreException</code> warning messages?</a></li>
  <li><a href="#proxyServerAndGeneratedURLs">My TDS server is behind a proxy server.
    Why do some TDS generated URLs point to my TDS server instead of my proxy server?</a></li>

  <li><a href="#JoinExisting">I have modified my configuration of a JoinExisting Aggregation dataset, but nothing has changed.</a></li>
</ul>
<h2>Tomcat</h2>
<ul>
  <li><a href="#permGenOutOfMemoryError">I'm getting the error "java.lang.OutOfMemoryError: PermGen<a name="PermGen"></a> space". Whats up?</a></li>
  <li><a href="#whoIsAccessing">Who is accessing my server?</a></li>
  <li><a href="#controlWebCrawlers">How can I control whether I want Web crawlers to access my server?</a></li>
  <li><a href="#preventAccess">How can I prevent someone from accessing my server?</a></li>
  <li><a href="#removeServletAutodeploy">How do I remove Servlet Autodeploy?</a></li>
  <li><a href="#howRemovePort8009">How do I remove port 8009 when using tomcat in standalone mode?</a></li>
</ul>

<hr width="100%">
<h2>Catalogs</h2>
<p>Q:<a name="CatalogURLs"></a> How do I construct the URLs I find in a THREDDS Catalog? <br>
</p>
<p>A: Heres the general idea in the <a href="http://www.unidata.ucar.edu/projects/THREDDS/tech/tds4.2/tutorial/BasicConfig.html">tutorial</a> and the <a href="http://www.unidata.ucar.edu/projects/THREDDS/tech/catalog/v1.0.2/InvCatalogSpec.html#constructingURLs">reference</a> docs. If you are using the CDM library, you can call </p>
<pre>InvAccess.getUrlPath()</pre>
<hr width="100%">
<h2>TDS</h2>
<h4><a name="throttleRequests"></a>Q: How do I keep client requests from overwhelming my server?</h4>

<blockquote>
  <p>There is currently no per-client resource throttle, unfortunately, but we are aware
    of the eventual need for that. Any given request is single-threaded, so cant hog too
    many resources. One can limit the size of opendap responses, which tends to be the
    main problem on our server anyway. See the
    <a href="./reference/ThreddsConfigXMLFile.html#opendap">OPeNDAP section</a>
    of the threddsConfig.xml page for details.
  </p>
</blockquote>

<hr width="50%" align="left">

<h4><a name="tooManyFilesOpen"></a>
  Q: Can aggregations of many files cause "too many files open" problems?</h4>
<blockquote>
  <p>Aggregations only open one file at a time, and then close it., so this wont cause
    "too many file" problems.</p>
  <p>If you have "too many open files" errors, then either theres a file leak (which we
    would like to know about), or you have your file cache limit set too high relative
    to your OS file handle limit.</p>
</blockquote>

<hr width="50%" align="left">

<h4>Q: <a name="nonHttpStatusCodes">What do the non-HTTP status codes in the <code>threddsServlet.log</code> files mean?</a></h4>
<blockquote>
  <p> The "Request Completed" messages in the <code>threddsServlet.log</code> files contain
    several fields including a status code.
    the HTTP status code returned in a completed response. If a request is forwarded to
    another internal service, a "1000 (Forwarded)" or "1001 ( </p>
  <pre>2009-06-17T13:25:54.451 -0600 [     28949][      11] INFO<br>  - thredds.server.catalogservice.LocalCatalogServiceController<br>  - handlePublicDocumentRequest(): Request Completed - 1001 - -1 - 32<br></pre>
</blockquote>

<hr width="50%" align="left">

<h4>Q: <a name="inconsistentArrayLength">I'm seeing the error "Inconsistent array length read: 538976288 !=  1668244581' when I open the dataset in the IDV. Why?</a></h4>
<blockquote>
  <p>The error "Inconsistent array length read" only tells you that there was an error on
    the server in the middle of responding to an OPeNDAP request. You then must look in
    the <strong>threddsServlet.log</strong> and find the error to know why. </p>
</blockquote>

<hr width="50%" align="left">

<h4><a name="javaUtilPrefs"></a>Q: Why am I getting lots of
  <code>java.util.prefs.BackingStoreException</code> warning messages?</h4>

<blockquote>
  <p>If you allow and use the TDS WMS service, you may be seeing warning messages in your
    Tomcat <code>catalina.out</code> log file that look something like this:</p>
  <pre style="margin-left: 40px;">May 25, 2010 6:28:22 PM java.util.prefs.FileSystemPreferences syncWorld<br>WARNING: Couldn't flush system prefs: java.util.prefs.BackingStoreException: /etc/.java/.systemPrefs/org create failed.</pre>

  <p>You can get rid of these messages by setting the "java.util.prefs.systemRoot"
    system property to a location that is writable by the user that Tomcat runs under.
    We have done this on our server by adding the following to <code>JAVA_OPTS</code>
    in the <code>${TOMCAT_HOME}/bin/setenv.sh</code> file:</p>

  <pre>-Djava.util.prefs.systemRoot=$CATALINA_HOME/content/thredds/javaUtilPrefs<br></pre>

  <p>You must make sure that the <code>javaUtilPrefs</code> directory exists and that
    <code>javaUtilPrefs/.systemPrefs</code> directory exists and is writable (again, by
    the user under which Tomcat is run).</p>
  <p>If you are interested in more details of the problem, here are two useful links:</p>
  <ul>
    <li>Sun bug # <a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4751177">4751177</a>
      ("Preferences storage placed unavailable to non-root users")</li>
    <li>"<a href="http://allaboutbalance.com/articles/disableprefs/">Disabling Sun's Java 1.4.x Preferences Subsystem</a>"</li>
  </ul>
</blockquote>

<hr width="50%" align="left">

<h4><a name="proxyServerAndGeneratedURLs">Q: My TDS server is behind a proxy server.
  Why do some TDS generated URLs point to my TDS server instead of my proxy server?</a></h4>

<blockquote>
  <p>Most TDS generated URLs are relative to the server (e.g., "/thredds/dodsC/") or relative to
    the the current document's base URL. There are only a few places where it is necessary to
    generate absolute URLs. In those cases, the TDS uses information from the incoming HTTP request
    to construct the generated URLs. It is up to the proxy to send the correct information to the
    proxied server so the request information will be correct.</p>

  <p>For more information, see our <a href="reference/TomcatBehindProxyServer.html">web page on
    running Tomcat behind a proxy server</a>. It contains links to Tomcat documentation
    on both mod_proxy and mod_jk as well as some user contributed documentation on setting up
    mod_proxy.</p>
</blockquote>

<hr width="50%" align="left">
<h4><a name="JoinExisting"></a><a>Q: I have modified my configuration of a JoinExisting Aggregation</a> dataset, but nothing has changed.</h4>
<blockquote>
  <p> The files and coordinates in a JoinExisting Aggregations are cached, and   in some circumstances wont get updated. The default location for the   cache is <strong>${tomcat_home}/content/thredds/cacheAged/</strong> unless you change it   in the<a href="reference/ThreddsConfigXMLFile.html#AggregationCache"> threddsConfig.xml </a>file.
Go to that directory, there will be files with the name of the cached   dataset(s). Delete the file for the dataset that needs updating and   restart Tomcat.</p>
  <p>&nbsp;</p>
</blockquote>
<hr width="100%">
<h2>Tomcat<a name="tomcat"></a></h2>

<h4>Q: <a name="permGenOutOfMemoryError">Im getting the error "java.lang.OutOfMemoryError: PermGen<a name="PermGen"></a> space". Whats up?</a></h4>
  <blockquote>
    <p>If you reload the <strong>thredds.war</strong> webapp enough times without restarting Tomcat, you will eventually run into "<strong>java.lang.OutOfMemoryError: PermGen space</strong>". This is a known bug in  JDK/Tomcat. The only thing to do is to stop and restart Tomcat. </p>
    <p>You can increase PermGen using this JVM option:     </p>
    <p><strong>-XX:MaxPermSize=128m    </strong></p>
    <p>On
the JDK1.6 -server JVM, the default seems to be 64m. However, with
enough redeploys , you will eventually run out of PermGen space no
matter what your <strong>MaxPermSize</strong> setting is. We have
gotten into the habit of restarting tomcat on our production server
whenever we redeploy. Lots of redeploys only happen on our test server.</p>
    <p>Resources:</p>
    <ul>
      <li><a href="http://blogs.sun.com/fkieviet/entry/classloader_leaks_the_dreaded_java">"Classloader leaks" (sun blog)</a> (2006-10-16)</li>
      <li>"<a href="http://my.opera.com/karmazilla/blog/2007/09/29/return-of-the-permgen">Return of the PermGen</a>" (2007-09-29)</li>
      <li>"<a href="http://my.opera.com/karmazilla/blog/2007/03/15/permgen-strikes-back">PermGen Strikes Back</a>" (2007-03-15)</li>
      <li>"<a href="http://my.opera.com/karmazilla/blog/2007/03/13/good-riddance-permgen-outofmemoryerror">Good Riddance PermGen OutOfMemoryError</a>" (2007-03-13)</li>
    </ul>
  </blockquote>

<hr width="50%" align="left">

  <h4>Q: <a name="whoIsAccessing">Who is accessing my server?</a> </h4>
  <blockquote>
    <p>When you examine the TDS access logs, you can see who is accessing the TDS by IP address. Use <strong>nslookup &lt;ip address&gt;</strong> to find out the host name. </p>
  </blockquote>

<hr width="50%" align="left">

  <h4>Q: <a name="controlWebCrawlers">How can I control whether I want Web crawlers to access my server?</a></h4>
  <blockquote>
    <p>Well-behaved web crawlers are supposed to look for a <strong>robots.txt</strong>
file on the server and follow its instructions. To set up a robots.txt
file that excludes web crawlers from crawling your server, follow <a href="./reference/Performance.html#robots">these directions</a>. </p>
  </blockquote>

<hr width="50%" align="left">

<h4>Q: <a name="preventAccess">How can I prevent someone from accessing my server?</a> </h4>
<blockquote>
  <p>If your server is being overwhelmed by requests from a particular user/computer, it is best to exclude
    them using their IP address rather than their hostname (this avoids having to perform a DNS lookup for
    each request). To do so, edit the <strong>${tomcat_home}/conf/server.xml</strong> file and find the
    "localhost" <strong>Host</strong> element. Add a RemoteAddrValve <strong>Valve</strong> element as
    follows:
  </p>

  <blockquote>
  <pre>
&lt;Host name=&quot;localhost&quot; debug=&quot;0&quot; appBase=&quot;webapps&quot; .. &gt;
  <strong>&lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; deny=&quot;18\.83\.0\.150&quot; /&gt;</strong>
  ...
&lt;/Host&gt;
  </pre>
  </blockquote>

  <p>The value of the deny attribute must be one or more (comma delimited) regular expressions each of which will
    be compared to the remote clients IP addresses. For instance:</p>

  <blockquote>
  <pre>
deny="18\.83\.0\.150,128\.100\.34\.99,128\.117\.140\..*"
  </pre>
  </blockquote>
  <p>NOTE: You need to restart the server before this will take effect.</p>
</blockquote>

<hr width="50%" align="left">

  <h4>Q: <a name="removeServletAutodeploy">How do I remove Servlet Autodeploy?</a></h4>
  <blockquote>
    <p>Its
recommendded to remove autodetection of changes while Tomcat is
running, for performance reasons. In a production environment, its
better to explicitly redeploy the application: </p>
    <pre>   &lt;Host name="localhost" appBase="webapps" unpackWARs="true" <strong>autoDeploy="false"</strong>
     xmlValidation="false" xmlNamespaceAware="false"&gt;
   ...
  &lt;/Host&gt;</pre>
  </blockquote>

<hr width="50%" align="left">

  <h4>Q: <a name="howRemovePort8009">How do I remove port 8009 when using tomcat in standalone mode?</a></h4>
  <blockquote>
    <p>Unless you are using Tomcat with the Apache server, comment out this line in <strong>server.xml:</strong> </p>
    <pre>  &lt;Connector port="8009" enableLookups="false" redirectPort="8443" protocol="AJP/1.3" /&gt;<br>
  </pre>
</blockquote>

<hr>
  <h3>Tomcat Resources</h3>
  <ul>
    <li><a href="http://jakarta.apache.org/tomcat/faq/">Tomcat FAQ (Apache site)</a> </li>
    <li><a href="http://tomcat.apache.org/tomcat-5.5-doc/index.html">Tomcat 5.5 documentation</a></li>
    <li><a href="http://www.coreservlets.com/Apache-Tomcat-Tutorial/">tutorial</a></li>
  </ul>

  <hr>
<address>
<img src="../images/thread.png" alt="THREDDS" height="108" width="110">
  This document is maintained by Unidata and was last updated May 2010.
  Send comments to <a href="mailto:support-thredds@unidata.ucar.edu">THREDDS support</a>.
</address>

</body></html>