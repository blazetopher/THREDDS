<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <title>Running Tomcat Behind a Proxy Server</title>
</head>
<body>
<h1><img src="../../images/unidataLogo.png" width="75" height="75" align="middle" alt="Unidata">Running Tomcat Behind a Proxy Server</h1>

<hr>

<p>Two issues can arise when running the TDS behind a proxy server. First, you must get the proxy configuration
  correct so that Tomcat and the TDS know the correct <code>server:port</code> and context path. Second, if your
  proxy changes the TDS context path (e.g., changing the default "/thredds" to something more project specific
  like "/projX/thredds").</p>

<h2>Proxy Configuration</h2>
<p>See the sections below for <a href="#tomcatProxyDocs">links to some Tomcat documentation on proxying</a> and
  some <a href="#modProxy">contributed documentation from several users</a>.</p>

<p>You can check the <code>server:port</code> and context path that TDS is being handed by Tomcat for each
  request if you have <a href="RemoteManagement.html">TDS Remote Management</a> set up. From the debug page
  the TDS Remote Management enables ("<code>/thredds/admin/debug</code>"), follow the "Show Http Request
  Info" link and look for the values of <code>req.getServerName()</code>, <code>req.getServerPort()</code>,
  and <code>req.getContextPath()</code>.</p>

<h2><a name="chgContextPath"></a>Changing the TDS Context Path</h2>
<p>The second issue only comes up if your proxy changes the TDS webapps contextPath (e.g., from the default
  "/thredds" to a project specific one like "/projX/thredds"). In this case, you must edit the TDS web.xml
  file (located in <code>$TOMCAT_HOME/webapps/thredds/WEB-INF/web.xml</code>).
  Near the very top of the web.xml file, you must change the following section:
</p>
<pre>
&lt;context-param&gt;
  &lt;param-name&gt;ContextPath&lt;/param-name&gt;
  &lt;param-value&gt;thredds&lt;/param-value&gt;
&lt;/context-param&gt;
</pre>
<p>to, using the above example:</p>
<pre>
&lt;context-param&gt;
  &lt;param-name&gt;ContextPath&lt;/param-name&gt;
  &lt;param-value&gt;projX/thredds&lt;/param-value&gt;
&lt;/context-param&gt;
</pre>
<p><strong>NOTE</strong>: This requirement will go away in a future release once we start requiring Tomcat 6.0.</p>

<hr>

<h2><a name="tomcatProxyDocs"></a>Tomcat Documentation</h2>
<ul>
  <li>mod_proxy
    <ul>
      <li><a href="http://tomcat.apache.org/tomcat-6.0-doc/proxy-howto.html">Tomcat 6.0 Proxy Support HOW-TO</a></li>
      <li><a href="http://tomcat.apache.org/tomcat-5.5-doc/proxy-howto.html">Tomcat 5.5 Proxy Support HOW-TO</a></li>
    </ul>
  </li>
  <li>mod_jk
    <ul>
      <li><a href="http://tomcat.apache.org/connectors-doc/webserver_howto/apache.html">Apache Tomcat Connector - Webserver HowTo</a></li>
      <li><a href="http://tomcat.apache.org/connectors-doc/">Apache Tomcat Connector</a></li>
    </ul>
  </li>
  <li>
    <a href="http://oreilly.com/catalog/9780596101060/chapter/ch04.pdf">Tomcat Tuning</a> free online chapter in
    <a href="http://oreilly.com/catalog/9780596101060/index.html"> Tomcat: The Definitive Guide</a> (2007) has
    some timing comparisions between Tomcat and Apache http. You might be surprised at the results.
  </li>
</ul>

<h2><a name="modProxy"></a>Tomcat and Apache mod_proxy</h2>
<p>[Thanks to Michael Godin (MBARI) and Greg Keith and Ernie Joynt (NOAA) for the following documentation.]</p>

<p>If you are using Tomcat on port 8080 (for example) and Apache on the
default port 80, you can use the Apache proxy module to hide the Tomcat
port in the URLs used to connect to THREDDS.&nbsp; This may be critical
if your server is behind a firewall that only allows port 80
access.&nbsp; It is also important if THREDDS is running on a machine
that is completely behind a firewall, but you have a server running
Apache that can talk to the machine.</p>
<p>You will need to edit the Apache httpd.conf file (on Linux, it is stored in /etc/httpd/conf/).</p>
<p>Find the lines that start with "&lt;IfModule mod_proxy.c&gt;" and
end with "&lt;/IfModule&gt;".&nbsp; These lines may need to be
uncommented.&nbsp; Between these lines, make sure the following line
exists and is uncommented:</p>
<pre>    ProxyRequests On<br></pre>
<p>Then add the following lines:</p>
<pre>    ProxyPreserveHost On<br>    &lt;Location /thredds&gt;<br>        ProxyPass <a class="moz-txt-link-freetext" href="http://myhost.mydomain:8080/thredds">http://myhost.mydomain:8080/thredds</a><br>        ProxyPassReverse <a class="moz-txt-link-freetext" href="http://myhost.mydomain:8080/thredds">http://myhost.mydomain:8080/thredds</a><br>    &lt;/Location&gt;<br>    &lt;Proxy <a class="moz-txt-link-freetext" href="http://myhost.mydomain:8080/thredds">http://myhost.mydomain:8080/thredds</a>&gt;<br>        AllowOverride None<br>        Order allow,deny<br>        Allow from All<br>    &lt;/Proxy&gt;<br></pre>
<p>You of course need to replace "http://myhost.mydomain:8080/thredds" with the full URL of the THREDDS web application.</p>
<p>The section between &lt;Proxy... And &lt;/Proxy&gt; can usually be
omitted, but in some cases a server is sufficiently locked down that
you need to explicitly allow access to resources.&nbsp; It can also be
edited to restrict access to registered users via Apache authentication
mechanisms.</p>
<p>You can also add additional proxy directives to mask the THREDDS URL  and port in any TDS-generated file access pages. The above ProxyPass  and ProxyPassReverse directives mask the machine name and port using  mod_proxy during an initial THREDDS URL request, but leave this  information visible on the data access page generated by TDS.    </p>
<p>If you add the following directives BEFORE the directives above,  Apache will use mod_proxy_ajp in addition to the mod_proxy directives,  so that any TDS-generated access pages will use the same URL as shown  in the initial THREDDS request (example shown for Apache 2.2):    </p>
<pre>  LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
  ProxyPass /thredds         ajp://localhost:8009/thredds
  ProxyPassReverse /thredds  ajp://localhost:8009/thredds    </pre>
<p>This also requires uncommenting the AJP connector (port 8009) in the  Tomcat server.xml file.</p>
<p>Finally, on the server command line (as a super/admin user), execute:</p>
<pre>    apachectl graceful<br></pre>
<p>In my configuration, I initially failed to add the line
"ProxyPreserveHost On", which caused me many headaches as links
generated by THREDDS kept directing the client back to port 8080 (which
was blocked by a firewall).</p>

<h2><a name="modJk"></a>Tomcat and Apache mod_jk</h2>
<p>Sounds like mod_jk is more powerful than mod_proxy. If anyone has experience using
  mod_jk and could contribute some text here, please let us know at
  <a href="mailto:thredds@unidata.ucar.edu">thredds@unidata.ucar.edu</a>.</p>

<hr width="100%">

<address>
<img src="../../images/thread.png" alt="THREDDS" height="108" width="110">
  This document is maintained by Unidata and was last updated September 2010.
  Send comments to <a href="mailto:support-thredds@unidata.ucar.edu">THREDDS support</a>.
</address>

</body></html>