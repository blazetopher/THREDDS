<!DOCTYPE html PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html><head>

  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <title>Basic Tomcat Management and Security</title>
</head>
<body>

<h1><img src="THREDDSlogo.jpg" height="54" width="67">Basic Tomcat Management and Security </h1>
<hr>

At this point we assume that Tomcat is installed in
<code> /home/workshop/tds/apache-tomcat-6.0.13 </code>
and that you have an environment variable TOMCAT_HOME set to this value.
<p>
Check that this variable is set by with this command:
<p>
<code> echo $TOMCAT_HOME</code>
<p>

If the system indicates that the variable is not set, recall that you can
set this variable in any window at any time by executing the command:
</p>
<code> set TOMCAT_HOME /home/workshop/tds/apache-tomcat-6.0.13  </code>




<h2>Important Tomcat Directories </h2>

Here we examine some Tomcat relevant directories, the directories .  Do
<p>
<code>cd $TOMCAT_HOME </code>

<h3> The <code> webapps </code> Directory </h3>
<p>
The <code> webapps </code> directory is where web applications are placed to be
    run by Tomcat.  Tomcat automatically monitors this directory and when it finds
    a new
    <code>.war</code> file it will attempt to install it as an application.  If
there is an error in the deployment, such as a problem with the file, it will report
that in the the log file <code> catalina.out </code>.
<p>
    Do this:
<p>
<code>ls $TOMCAT_HOME/webapps</code>
<p>
    Among other things, you should see the <code> thredds.war </code> file that was previously installed,
    and a directory called <code> thredds</code>.  This is the TDS code.
    Tomcat installed the
    TDS automatically when the <code>thredds.war</code> file was placed there.
</p>
<p>
    You will also see a file here called <code>manager</code>.  This is the Manager
    application that we will visit soon.
</p>

<p>
<h3> The <code> logs </code> Directory    </h3>
The <code> logs </code> directory contains Tomcat log files.  Do this:
    <p>
        <code> ls $TOMCAT_HOME/logs </code>
    </p>
    <p>
        Once Tomcat has been started it will generate some log files and put them in
        the <code>logs </code> directory.  The files
        that are generated depends on how the server is configured.  Here is an
        example from one recent Tomcat installation using the default configuration:
        <pre>
[tomcat@lead3 ~/logs]$ ls -lt
total 12
-rw-r--r-- 1 tomcat leadstaff 2806 Jul 22 20:01 catalina.out
-rw-r--r-- 1 tomcat leadstaff  232 Jul 21 20:01 localhost.2007-07-21.log
-rw-r--r-- 1 tomcat leadstaff 1585 Jul 21 20:01 catalina.2007-07-21.log
-rw-r--r-- 1 tomcat leadstaff    0 Jul 21 20:00 admin.2007-07-21.log
-rw-r--r-- 1 tomcat leadstaff    0 Jul 21 20:00 host-manager.2007-07-21.log
-rw-r--r-- 1 tomcat leadstaff    0 Jul 21 20:00 manager.2007-07-21.log

        </pre>

    </p>

</p>
<p>
<h3> The <code> conf </code> Directory   </h3>
</p>
<p>
<h3> The <code> exec</code> Directory   </h3>
</p>


<h2>Tomcat Security</h2>

We believe Tomcat to be secure enough for typical scientific uses. There are no known security exploits or weaknesses. However, the Internet is a wild place, and we are not security experts so caveat emptor.




<h3> Using Authentication to Restrict Access to Tomcat Applications</h3>

Although by default tomcat does not require authentication to access the resources
it controls, it can be configured to do so.   From a TDS perspective, authentication
is required to 1) get access to the tomcat manager application, and 2) enable remote
TDS management.
<p>
This section introduces the Tomcat authentication mechanism by describing how to
    enable authentication in order to use the Tomcat manager.   (Enabling remote
    TDS management is described in Section X.)






<h3> The Tomcat Manager </h3>

The tomcat manager is an application that allows users to deploy, undeploy, or
reload an application such as the TDS without having to shut down and restart tomcat.
The tomcat distribution contains this application, but for security reasons it is
disabled by default.

<p>
Execution of the tomcat manager requires that users authenticate themselves and
    be associated with the predefined role “manager”.  That is, users must provide
    a user name and password, and their user name must be associated with the
    manager role.  By default, this information is stored in the file
    ${tomcat_home}/conf/tomcat-users.xml.

<h3> tomcat-users.xml</h3>

A simple tomcat-users.xml file looks like this:

<tomcat-users>

  <user name="Anne" password="secret" roles="tdrAdmin" />

</tomcat-users>

There must be an entry in the file for each user that is required to authenticate.
Each <user> entry defines the user name, password, and roles that are assigned to
that user.

<p>
Tomcat-users.xml is read once when Tomcat is started.  For this reason, changes to
    tomcat-users.xml will not be recognized until Tomcat is restarted.  When a user
    attempts to access a protected resource for the first time, Tomcat will challenge
    the user for a user name and password.  Once the user has been authenticated, the
    relevant information, including the roles to which the user was assigned, is
    cached for the duration of the user’s login.







<h3> Configuring tomcat-users.xml to Allow a User to Execute the Manager </h3>

In order to allow a user to execute the manager, the user's name and password must
be added to the tomcat-users.xml file, and the user must be assigned the <q>manager</q>
role, which is a predefined role in Tomcat.

<p>
Role names such as <code> manager </code> should be added to the <q>role</q>
    attribute of a
    <code> &lt;user&gt; </code>
element.  The value of the role attribute can be a single value or a comma separated
list of values.  For example, to add the manager role to the user “anne” in the above
example, the result would look like this:

<code>
  <user name="Anne" password="secret" roles="tdrAdmin,manager" />
</code>

Exercise:  Modify the default tomcat-users.xml to add yourself as a user and give
yourself the role of “manager”.  Start (or restart) Tomcat, and ensure that you can
access the manager application.

<p>
Test this change by pointing your browser to http://localhost:8080 and then click
    on the “Manager” link in the left hand column.  You’ll see that you will not be
    challenged on getting the Tomcat splash page, but you will be challenged when you
    try to access the manager.

<p>
Go to the directory ~tomcat/logs and list the files.  You might? Should? see a file
    called something like localhost_accessLog.  Is this enabled on the machines?
    Tail the log (run “tail –f localhost_accessLog) and try to access the manager
    again.  This log will show you the HTTP status codes returned by tomcat.  You’ll
    see …

<p>
<b>Exercise:</b> This exercise is to help you learn to debug tomcat problems.
    Modify tomcat-users.xml, but make sure there’s some problem with the XML format.
    For example, leave off a closing angle bracket.  In the logs directory
    (~tomcat/logs) tail the file catalina.out as you restart Tomcat.  The log
    file should report some kind of error that would, in theory, lead you to
    reexamine tomcat-users.xml and help you find the error.





<h3> Using Digested Passwords </h3>

By default, Tomcat expects user passwords to be stored in clear text.  As you can
imagine, this is not very secure.  Tomcat also supports digested passwords, a type
of encoding, but it must configured to use them.   This configuration is done in the
Tomcat configuration file ${tomcat_home}/conf/server.xml.

<p>
There are several digest algorithms.  Here we will use the SHA algorithm.

<p>
In addition it is necessary to create the digested passwords.  Tomcat provides
    a script, digest.sh, that creates a digested version of a password.  You must
    then copy the digested version into tomcat-users in place of the clear text
    password.

<p>
Tomcat will request that a browser client like Firefox provide a digested password.
    The client must digest the password using the same algorithm.  Your browser
    will do this for automatically.

Configuring Tomcat to Use Digested Passwords

<p>
Configure tomcat to use digested passwords by editing the file server.xml by
adding a “digest” attribute to Tomcat’s <realm> element, like this:

<Realm className="org.apache.catalina.realm.MemoryRealm" digest="SHA" />

<p>
(Find where this is on the workshop machines.)

say where.



Restart the server for this change to take effect.


<h2> Enabling Secure Communication to Tomcat Via SSL Encryption </h2>

Using digest passwords eliminates the problem of storing passwords in clear text.
But it does not address the possibility of snooping on a connection to the server.
By enabling SSL on the server we require clients to SSL encode their requests.
This prevents network sniffers from acquiring sensitive information.

<p>
Besides encoding information sent to the server, the SSL protocol also requires
    that the server authenticate to the client.  This is to prevent a spoof from
    pretending to be a trusted server and fraudulently obtaining sensitive
    information.  For this reason, to enable SSL it is first necessary to create
    an SSL certificate for the server.  This is a credential that is passed to
    the client upon initiating a connection that certifies the servers identity.
    Among trusted sites, it is sufficient for the server to send a "self-signed"
    certificate, the creation of which is described here.  If you are interested
    in using more secure certificates, see the Section called Installing a
    Certificate from a Certificate Authority in Section X.


<h3>Creating a Self-Signed Certificate </h3>

To create a self-signed certificate, you must first create a “keystore” file
where certificates are stored.  Java provides a tool, called keytool, that
generates a self-signed certificate and puts in a keystore file.  The default
keystore filename is ${user_home}/.keystore.  However, this example will use
the filename ${tomcat_home}/conf/keystore-tomcat.

<p>
To create a self-signed certificate and store it in
    ${tomcat_home}/conf/keystore-tomcat, execute this command:
<p>
    <code>
/usr/java/jdk1.5.0_10/bin/keytool -genkey -alias tomcat -keyalg RSA -validity 365 -keystore $HOME/conf/keystore-tomcat
</code>

<p>
You will receive this series of questions:

<pre>

Enter keystore password:  changeit

What is your first and last name?

  [Unknown]:  localhost

What is the name of your organizational unit?

  [Unknown]:  tomcat server

What is the name of your organization?

  [Unknown]:  Anne's Home

What is the name of your City or Locality?

  [Unknown]:  Boulder

What is the name of your State or Province?

  [Unknown]:  Colorado

What is the two-letter country code for this unit?

  !

 [Unknown]:  US

Is CN=localhost, OU=tomcat server, O=Anne's Home, L=Boulder, ST=Colorado, C=US correct?

  [no]:  yes



Enter key password for <&lttomcat>

        (RETURN if same as keystore password):

</pre>

<p>
Say more here: “changeit”, hostname, validity option, etc.

<p>
Exercise: Create the keystore file.


<h3> Configure Tomcat to Use SSL Encryption     </h3>

Next, it is necessary to configure the tomcat server to use this new keystore file.  This requires a modification to the Tomcat configuration file ${tomcat_home}/conf/server.xml.   A small section on server.xml here?

<p>
In that file find the Connector element that uses port 8443, the SSL port.  Ensure that that Connector XML element is not commented out.  Also, to that element add the ?argument? keystoreFile and optionally the argument keystorePass if you are no longer using the default password so that it looks similar to this:

<!-- Define a SSL Coyote HTTP/1.1 Connector on port 8443 -->


  <Connector port="8443"

    maxThreads="150" minSpareThreads="25" maxSpareThreads="75"

    enableLookups="false" disableUploadTimeout="true"

    acceptCount="100" debug="0" scheme="https" secure="true"

    clientAuth="false" sslProtocol="TLS"

    keystoreFile="${keystore_filename}"

    keystorePass="mypassword"/>

from begonia:

<!-- Define a SSL HTTP/1.1 Connector on port 8443 -->

  <Connector port="8443" maxHttpHeaderSize="8192"

    maxThreads="150" minSpareThreads="25" maxSpareThreads="75"

    enableLookups="false" disableUploadTimeout="true"

    acceptCount="100" scheme="https" secure="true"

    clientAuth="false" sslProtocol="TLS"

    keystoreFile="/opt/tomcat/conf/keystore-tomcat" />

<p>
Finally, restart the Tomcat server to pick up these changes.

<p>
Exercise: configure Tomcat to use SSL.  Restart Tomcat, and connect via your browser.


    Other Tomcat Security Resources

<p>
In any case, we strongly recommend that you also read and follow the Tomcat/TDS Security guidelines.

Higher Security: You can also use an LDAP server or a Database to store users and roles, which may give you higher levels of security. Use of this feature is beyond the scope of this documentation, however.
Leftover Stuff To Consider
Checking that the correct ports are enabled

After restarting Tomcat, you can use netstat -an command to check that the ports are correctly configured. You should see lines like:

  TCP    127.0.0.1:8080         0.0.0.0:0              LISTENING

  TCP    127.0.0.1:8443         0.0.0.0:0              LISTENING

You also need to make sure that your firewall is allowing those ports through.
TroubleShooting

    * Connection refused when trying to access a restricted page. The SSL socket is not enabled in the server.xml file, or you didn't install a certificate in the keystore.
    * What's in the keystore?
          o Look at the Tomcat Server Status page and check the JVM Version.
          o From command line, make sure that this matches the results of 'java -version'. If not, then your Tomcat server is starting up with a different JVM.
          o From command line, 'keytool -list' will show you what's in the default keystore. Standard is to have password changeit. You need an entry named tomcat.

Running without SSL

If you are on a secure network, and don't want to run with SSL enabled, edit ${tomcat_home}webapps/thredds/WEB-INF/web.xml and change all instances of CONFIDENTIAL to NONE.

Password authentication will then be done without SSL encryption. You will have to repeat this whenever you reinstall or upgrade thredds.war.
Resources

    * Tomcat SSL Configuration
    * Java Secure Sockets Extension (JSSE) Reference Guide
    * JDK keytool application

This document is maintained by Anne Wilson and was last updated on July 18, 2007







<hr width="100%">
<strong><br>
</strong>
<address>
<img src="../images/thread.png" height="108" width="110">This document is maintained by Unidata and was last updated on July 23, 2007. Send comments to <a href="mailto:support-thredds@unidata.ucar.edu">THREDDS support</a>.<br>

</address>

<p>&nbsp;</p>

</body></html>