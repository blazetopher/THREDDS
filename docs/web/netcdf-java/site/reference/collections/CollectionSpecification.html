<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>Section Specification</title></head>
<style type="text/css">
pre {font-size: 9pt; padding: 10px; background-color: #E7E7E7; border: 1px solid #CFCFCF; width: 85%;}
code {font-size: 11pt;}
dl {margin: 10px 5px 5px 15px;)
.style1 {font-style: italic}
</style>
<body>
<h1>Collections Specification</h1>
<p>A <em><strong>collection specification string</strong></em>  creates a collection on the fly. Currently (4.1) only works for point feature collections.</p>
<h3>Example</h3>
<pre>
/data/ldm/pub/native/grid/NCEP/GFS/Alaska_191km/**/GFS_Alaska_191km_#yyyyMMdd_HHmm#\.grib1
</pre>
<ul>
  <li>rootDir= /data/ldm/pub/native/grid/NCEP/GFS/Alaska_191km</li>
  <li>subdirs= yes </li>
  <li>dateFormatMark= GFS_Alaska_191km_#yyyyMMdd_HHmm</li>
  <li>onName= yes</li>
  <li>regexp= GFS_Alaska_191km.........\.grib1<br>
  </li>
</ul>
<h2>Use in CDM 4.1 library</h2>
<p><strong>FeatureDatasetFactoryManager.open(location, wantFeatureType)</strong> looks for <em><strong>collection:spec</strong></em> prefix for the location, and calls <strong>CompositeDatasetFactory.factory(wantFeatureType, spec)</strong> if found, which returns a FeatureDataset. Currently only a limited number of Point Feature tyeps are supported. This is an experimental feature.</p>
<h2>Proposed element in TDS, NcML</h2>
<p>Takes the place of datasetScan and scan.</p>
<pre>&lt;<strong>collection</strong> <strong>spec</strong>=&quot;/data/ldm/pub/native/satellite/3.9/WEST-CONUS_4km/WEST-CONUS_4km_3.9_#yyyyMMdd_HHmm#.gini&quot;<br>            <strong>recheckEvery</strong>=&quot;15 min&quot; <strong>olderThan</strong>=&quot;1 min&quot; /&gt;
</pre>
<blockquote>
  <p>where</p>
  <ol>
    <li><strong>spec</strong>: collection specification string</li>
    <li><strong>recheckEvery</strong>: allow coleection to be out -of-date by this much</li>
    <li><strong>olderThan</strong>: only files older than this<br>
    </li>
  </ol>
</blockquote>
<h3>  Example catalog elements:</h3>
<p><strong>model data:</strong></p>
<pre>&lt;<strong>featureCollection</strong> <strong>name</strong>=&quot;NCEP-GFS-Alaska_191km&quot; <strong>featureType</strong>=&quot;FMRC&quot; <strong>path</strong>=&quot;fmrc/NCEP/GFS/Alaska_191km&quot;&gt;<br>

   &lt;collection spec=&quot;/data/ldm/pub/native/grid/NCEP/GFS/Alaska_191km/**/GFS_Alaska_191km_#yyyyMMdd_HHmm#.grib1&quot; recheckEvery=&quot;15 min&quot; olderThan=&quot;5 min&quot; /&gt;
&lt;/featureCollection&gt;
</pre>
<p><strong>  point data:</strong></p>
<pre>&lt;<strong>featureCollection </strong><strong>name</strong>=&quot;6 minute&quot; <strong>featureType</strong>=&quot;STATION_PROFILE&quot; harvest=&quot;true&quot; <strong>path</strong>=&quot;station/profiler/wind/06min&quot;&gt;<br>  &lt;documentation type=&quot;summary&quot;&gt;Six minute average data.&lt;/documentation&gt;<br>  &lt;collection spec=&quot;/data/ldm/pub/native/profiler/wind/06min/**/PROFILER_wind_06min_#yyyyMMdd#.nc&quot; recheckEvery=&quot;15 min&quot; olderThan=&quot;5 min&quot; /&gt;
&lt;/featureCollection&gt;
</pre>
<p><strong>satellite data:</strong><br>
</p>
<pre>
&lt;<strong>featureCollection name</strong>=&quot;WEST-CONUS_4km&quot; <strong>featureType</strong>=&quot;Grid&quot; <strong>harvest</strong>=&quot;true&quot; <strong>path</strong>=&quot;satellite/3.9/WEST-CONUS_4km&quot;&gt;<br>  &lt;collection spec=&quot;/data/ldm/pub/native/satellite/3.9/WEST-CONUS_4km/WEST-CONUS_4km_3.9_#yyyyMMdd_HHmm#.gini&quot; recheckEvery=&quot;15 min&quot; olderThan=&quot;1 min&quot; /&gt;<br>&lt;/featureCollection&gt;<br></pre>
<blockquote>
  <p>  where:</p>
  <ol>
    <li><strong>name</strong>: logical name of dataset. Auto generate this and ID if not present ??</li>
    <li><strong>featureType</strong>: required. processing is different for each type</li>
    <li><strong>path</strong>: logical URL of datset, as before</li>
  </ol>
  </blockquote>
<h3>Other goals:</h3>
<ul>
  <li>Default services depend on featureType, may be configured by User or overridden in catalog.</li>
  <li>Automatic metadata extraction (time/space BB and variable names)</li>
  <li>Default publisher/author etc added to each catalog.</li>
  <li>Allow references to template metadata</li>
</ul>
<h2>Retrofit NcML</h2>
<pre>
&lt;ncml&gt;
  &lt;modify outer&gt;
  &lt;aggregation&gt;
    &lt;modify inner&gt;
    &lt;scan or scanFmrc&gt;
  &lt;/aggregation&gt;
&lt;/ncml&gt;
  </pre>
<p>The aggregation element allows multiple datasets to be combined into a single logical dataset. There can only be one aggregation element in a netcdf element. </p>
<pre>
&lt;xsd:element name=&quot;aggregation&quot;&gt;
  &lt;xsd:complexType&gt;
    &lt;xsd:sequence&gt;
<strong>(1)</strong>  &lt;xsd:choice minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;
      &lt;xsd:element ref=&quot;group&quot;/&gt;<br>      &lt;xsd:element ref=&quot;dimension&quot;/&gt;<br>      &lt;xsd:element ref=&quot;variable&quot;/&gt;<br>      &lt;xsd:element ref=&quot;attribute&quot;/&gt;<br>      &lt;xsd:element ref=&quot;remove&quot;/&gt;<br>     &lt;/xsd:choice&gt;

<strong>(2)</strong>  &lt;xsd:element name=&quot;variableAgg&quot; minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;
      &lt;xsd:complexType&gt;
       &lt;xsd:attribute name=&quot;name&quot; type=&quot;xsd:string&quot; use=&quot;required&quot;/&gt;
      &lt;/xsd:complexType&gt;
     &lt;/xsd:element&gt;
<strong>(3)  </strong>&lt;xsd:element ref=&quot;promoteGlobalAttribute&quot; minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;/&gt;<br><strong>(4)</strong>  &lt;xsd:element ref=&quot;cacheVariable&quot; minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;/&gt;
<strong>(5)</strong>  &lt;xsd:element ref=&quot;netcdf&quot; minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;/&gt;

<strong>(6)</strong>  &lt;xsd:element name=&quot;scan&quot; minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;
      &lt;xsd:complexType&gt;
<strong>(7)</strong>    &lt;xsd:attribute name=&quot;location&quot; type=&quot;xsd:string&quot; use=&quot;required&quot;/&gt;
<strong>(8)</strong>    &lt;xsd:attribute name=&quot;regExp&quot; type=&quot;xsd:string&quot; /&gt;
(<strong>9)</strong>    &lt;xsd:attribute name=&quot;suffix&quot; type=&quot;xsd:string&quot; /&gt;<strong>
(10)</strong>   &lt;xsd:attribute name=&quot;subdirs&quot; type=&quot;xsd:boolean&quot; default=&quot;true&quot;/&gt;
<strong>(11)</strong>   &lt;xsd:attribute name=&quot;olderThan&quot; type=&quot;xsd:string&quot; /&gt;
<strong>(12)</strong>   &lt;xsd:attribute name=&quot;dateFormatMark&quot; type=&quot;xsd:string&quot; /&gt;
<strong>(13)</strong>   &lt;xsd:attribute name=&quot;enhance&quot; type=&quot;xsd:string&quot;/&gt;
      &lt;/xsd:complexType&gt;
     &lt;/xsd:element&gt;



<strong>(14)</strong> &lt;xsd:element name=&quot;scanFmrc&quot; minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;
      &lt;xsd:complexType&gt;
<strong>(7)</strong>    &lt;xsd:attribute name=&quot;location&quot; type=&quot;xsd:string&quot; <strong>
(8)</strong>    &lt;xsd:attribute name=&quot;regExp&quot; type=&quot;xsd:string&quot; /&gt;use=&quot;required&quot;/&gt;
<strong>(9)</strong>    &lt;xsd:attribute name=&quot;suffix&quot; type=&quot;xsd:string&quot; /&gt;
<strong>(10)</strong>   &lt;xsd:attribute name=&quot;subdirs&quot; type=&quot;xsd:boolean&quot; default=&quot;true&quot;/&gt;
<strong>(11)</strong>   &lt;xsd:attribute name=&quot;olderThan&quot; type=&quot;xsd:string&quot; /&gt;

<strong>(15)</strong>   &lt;xsd:attribute name=&quot;runDateMatcher&quot; type=&quot;xsd:string&quot; /&gt;
<strong>    </strong>   &lt;xsd:attribute name=&quot;forecastDateMatcher&quot; type=&quot;xsd:string&quot; /&gt;
<strong>    </strong>   &lt;xsd:attribute name=&quot;forecastOffsetMatcher&quot; type=&quot;xsd:string&quot; /&gt;<br>      &lt;/xsd:complexType&gt;
     &lt;/xsd:element&gt;
    &lt;/xsd:sequence&gt;
    
<strong>(16)</strong> &lt;xsd:attribute name=&quot;type&quot; type=&quot;AggregationType&quot; use=&quot;required&quot;/&gt;
<strong>(17)</strong> &lt;xsd:attribute name=&quot;dimName&quot; type=&quot;xsd:token&quot; /&gt;
<strong>(18)</strong> &lt;xsd:attribute name=&quot;recheckEvery&quot; type=&quot;xsd:string&quot; /&gt;
<strong>(19)</strong> &lt;xsd:attribute name=&quot;timeUnitsChange&quot; type=&quot;xsd:boolean&quot;/&gt;
<br>
      &lt;!-- fmrc only  --&gt;<br><strong>(20)</strong> &lt;xsd:attribute name=&quot;fmrcDefinition&quot; type=&quot;xsd:string&quot; /&gt;<br>
&lt;/xsd:complexType&gt;
&lt;/xsd:element&gt;
</pre>
<ol>
  <li>Elements <em><strong>inside</strong></em> the &lt;aggregation&gt; get  applied to each dataset in the aggregation, before it is aggregated.  Elements <em><strong>outside</strong></em> the &lt;aggregation&gt; get applied to the aggregated  dataset.</li>
  <li>For <em><strong>joinNew</strong></em> aggregation types, each  variable to be aggregated must be explicitly listed in a <em><strong>variableAgg</strong></em> element. </li>
  <li>Optionally specify  global attributes to promote to a variable (outer aggregations only) with a <a href="#promoteGlobalAttribute">promoteGlobalAttribute</a> element. </li>
  <li>Specify which variables should be cached (outer aggregation only) with a <a href="#cacheVariable">cacheVariable</a> element. </li>
  <li>Nested <strong>netcdf</strong> datasets can be explicitly listed.</li>
  <li>Nested netcdf datasets can be implictly specified with a <strong>scan</strong> element.</li>
  <li>The scan directory <strong>location</strong>. </li>
  <li>If you specify a <strong>regExp</strong>, only files with whose full pathnames match the <a href="#regexp">regular expression</a> will be included.</li>
  <li>If you specify a <strong>suffix</strong>, only files with that ending will be included. A <strong>regExp</strong> attribute will override, that is, you cant specify both.</li>
  <li>You can optionally specify if the scan should  descend into <strong>subdir</strong>ectories (default true).</li>
  <li>If <strong>olderThan</strong> attribute is present, only files whose last modified date are older than this amount of time will be included. This is a way to exclude files that are still being written. This must be a <a href="http://www.unidata.ucar.edu/software/udunits/">udunit</a> time such as &quot;5 min&quot; or &quot;1 hour&quot;. </li>
  <li>A <strong>dateFormatMark</strong> is used on <strong><em>joinNew</em></strong> types to create date coordinate values out of the filename. It consists of a section of text, a '#' marking character, then a java.text.<a href="#SimpleDateFormat">SimpleDateFormat</a> string. The number of characters before the # is skipped in the filename, then the next part of the filename must match the SimpleDateFormat string. You can ignore trailing text. For example:
    <pre>
        Filename: SUPER-NATIONAL_1km_SFC-T_20051206_2300.gini 
 DateFormatMark: SUPER-NATIONAL_1km_SFC-T_#yyyyMMdd_HHmm</pre>
      <p><strong>Note that the dateFormatMark works on the name of the file, without the directories!!</strong></p>
    <p>A <strong>dateFormatMark</strong> can be used on a <strong><em>joinExisting</em> </strong>type only if there is a single time in each file of the aggregation, in which case the coordinate values of the time can be created from the filename, instead of having to open each file and read it.</p>
  </li>
  <li> You can optionally specify that the files should be opened in <a href="#enhance">enhanced mode</a> (default is <em>NetcdfDataset.EnhanceMode.None</em>). Generally you should do this if the ncml needs to operate on the datset after the COordSysBuilder has augmented it. Otherwise, you should not enhance.</li>
  <li>A specialized scanFmrc element can be used for a <em><strong><a href="../FmrcAggregation.html#forecastModelRunSingleCollection">forecastModelRunSingleCollection</a> </strong></em>aggregation, where forecast model run data is stored in multiple files, with one forecast time per file.</li>
  <li> For scanFmrc, the run date and the forecast date is extracted from the file pathname using a <strong>runDateMatcher </strong>and either a <strong>forecastDateMatcher </strong>or a<strong> forecastOffsetMatcher </strong>attribute<strong>. </strong>All of these require matching a specific string in the file's pathname and then matching a date or hour offset immediately before or after the match. The match is specified by placing it between '#' marking characters. The <strong>runDateMatcher </strong>and <strong>forecastDateMatcher </strong>has a java.text.<a href="#SimpleDateFormat">SimpleDateFormat</a> string before or after the match, while a <strong>forecastOffsetMatcher</strong> counts the number of 'H' characters, and extracts an hour offset from the run date. For example:
    <pre>     
             Filename:  gfs_3_20060706_0300_006.grb 
       runDateMatcher: #gfs_3_#yyyyMMdd_HH
forecastOffsetMatcher:                     HHH#.grb#</pre>
      <p>will extract the run date 2006-07-06T03:00:00Z, and the forecast offset &quot;6 hours&quot;. </p>
  </li>
  <li>You must specify an aggregation type.</li>
  <li>For all types except <em><strong>joinUnion</strong></em>, you must specify the dimension name to join. </li>
  <li>When you are using scan elements on a set of files that may change, and you are using caching, set <strong>recheckEvery</strong> to a valid <a href="http://www.unidata.ucar.edu/software/udunits/">udunit</a> time value, like &quot;10 min&quot;, &quot;1 hour&quot;, &quot;30 days&quot;, etc. Whenever the dataset is reacquired from the cache, the directories will be rescanned if <strong>recheckEvery</strong> amount of time has elapsed since the last time it was scanned. If you do not specify a recheckEvery attribute, the collection will be assumed to be non-changing.
    <p>The<strong> recheckEvery</strong> attribute specifies how  out-of-date you are willing to allow your changing datasets to be, not  how often the data changes. If you want updates to be  seen within 5 min, use 5 minutes here, regardless of the frequency of  updating.</p>
  </li>
  <li>Only for <strong><em>joinExisting</em> </strong>and<strong> <em>forecastModelRunCollection</em></strong> types: if <strong>timeUnitsChange</strong> is set to true, the units of the joined coordinate variable may change, so examine them and do any appropriate conversion so that the aggregated coordinate values have consistent units. </li>
  <li>Experimental, do not use. </li>
</ol>
<h3>&nbsp;</h3>
<p>&nbsp;</p>
<hr WIDTH="100%">
<address>
<img src="../../nc.gif" width="64" height="64"> This document is maintained by <a href="mailto:caron@unidata.ucar.edu">John Caron</a> and was last updated  Feb 2010
</address>
</body>
</html>
