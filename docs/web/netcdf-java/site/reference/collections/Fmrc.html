<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>FMRC</title>
<style type="text/css">
pre {font-size: 9pt; padding: 10px; background-color: #E7E7E7; border: 1px solid #CFCFCF; width: 85%;}
code {font-size: 11pt;}
dl {margin: 10px 5px 5px 15px;)
.style1 {font-style: italic}
</style>
</head>

<body>
<h1>FMRC Collections</h1>
<p>The file collections are managed with a <a href="FeatureCollections.html">CollectionManager</a>. Datasets are opened as GridDatasets, so that the coordinate system information is available.</p>
<p>Generally, datasets can be broken up by forecast time and/or variable, and the code automatically figures out what everything is. However, one cannot put output from multiple runs in the same file.</p>
<p>The ToolsUI FMRC tab (4.2) allows you to view internal strurctures of an FMRC.</p>
<h3>Opening an FMRC </h3>
<p>Use static method on ucar.nc2.ft.fmrc.Fmrc: </p>
<p><strong>public static Fmrc open(String collection, Formatter errlog, Formatter debug);</strong><br />
</p>
<p>
   The collection may be one of:
 <ol>
   <li><a href="CollectionSpecification.html">collection specification</a> string
    <li>catalog:catalogURL
   
    <li>filename.ncml
 </ol>
Â </p>
<h3>Run Date</h3>
<p>If a dateFormatMark is given, a DateExtractor extracts the rundate from the filename or URL. Otherwise there must be  global attributes <strong>_CoordinateModelBaseDate</strong> or <strong>_CoordinateModelRunDate</strong> inside each dataset.</p>
<h3>Forecast Date</h3>
<p>Each file is opened as a  GridDataset:</p>
<pre>gds = GridDataset.open( mfile.getPath());
</pre>
<p>and the forecast time coordinates are extracted from the grid coordinate system.</p>
<p>There is no need to specify <strong>forecastModelRunCollection</strong> vs <strong>forecastModelRunSingleCollectionc</strong>, nor <strong>timeUnitsChange</strong>. This is detected automatically.</p>
<h3>Regulate</h3>
<p>If true, then all runs for a given offset hour (from 0Z) are assumed to have the same forecast time coordinates. This obviates the need for the FMRC definition files which previously were used on motherlode. This evens out time coordinates, and allows for missing forecast times in the IDD feed.</p>
<h3>Persistent Caching</h3>
<p>An fmrInv.xml file is made the first time the file is seen. It is cached in bdb (MetadataManager). each collection string = bdb database. Each MFile in the collection:</p>
<pre> mm.put(file.getPath()+key, value);
</pre>
<p>ToolsUI collections tab allows you to delete database or individual elements.</p>
<h2>Conversion of &lt;datasetFmrc&gt; to &lt;featureCollection&gt;</h2>
<p>Old way:</p>
<pre>1) &lt;<strong>datasetFmrc</strong> name=&quot;NCEP-GFS-CONUS_80km&quot; <strong>collectionType=&quot;ForecastModelRuns&quot;</strong> harvest=&quot;true&quot; path=&quot;fmrc/NCEP/GFS/CONUS_80km&quot;&gt;
     &lt;metadata inherited=&quot;true&quot;&gt;
       &lt;documentation type=&quot;summary&quot;&gt;good stuff&lt;/documentation&gt;
     &lt;/metadata&gt;

2)   &lt;netcdf xmlns=&quot;http://www.unidata.ucar.edu/namespaces/netcdf/ncml-2.2&quot; enhance=&quot;true&quot;&gt;
       &lt;aggregation <em>dimName</em>=&quot;run&quot; <em>type</em>=&quot;forecastModelRunCollection&quot; <em>fmrcDefinition</em>=&quot;NCEP-GFS-CONUS_80km.fmrcDefinition.xml&quot; recheckEvery=&quot;15 min&quot;&gt;
         &lt;scan location=&quot;/data/ldm/pub/native/grid/NCEP/GFS/CONUS_80km/&quot; suffix=&quot;.grib1&quot; 
               dateFormatMark=&quot;GFS_CONUS_80km_#yyyyMMdd_HHmm&quot; subdirs=&quot;true&quot; olderThan=&quot;5 min&quot;/&gt;
       &lt;/aggregation&gt;
     &lt;/netcdf&gt;
3)   &lt;<em>fmrcInventory</em> location=&quot;/data/ldm/pub/native/grid/NCEP/GFS/CONUS_80km/&quot; suffix=&quot;.grib1&quot; fmrcDefinition=&quot;NCEP-GFS-CONUS_80km.fmrcDefinition.xml&quot; /&gt;
     &lt;<em>addTimeCoverage</em> datasetNameMatchPattern=&quot;GFS_CONUS_80km_([0-9]{4})([0-9]{2})([0-9]{2})_([0-9]{2})00.grib1$&quot; 
       startTimeSubstitutionPattern=&quot;$1-$2-$3T$4:00:00&quot;
       duration=&quot;240 hours&quot;/&gt;
   &lt;/datasetFmrc&gt;
</pre>
<ol>
  <li><strong>datasetFmrc</strong> replaced by<strong> featureCollection </strong>
    <ul>
      <li>optional <em>collectionType=&quot;ForecastModelRuns&quot;</em> -&gt; mandatory <em>featureType=&quot;FMRC&quot;</em> </li>
    </ul>
  </li>
  <li>NcML <strong>netcdf</strong> element describing the aggregation is now done by  <strong>collection</strong> element
    <ul>
      <li><strong>aggregation</strong> <em>dimName</em>, <em>type</em>, and <em>fmrcDefinition</em> are no longer needed</li>
      <li><strong>netcdf</strong> <strong>scan</strong> <em>location, suffix, subdirs, </em>and<em> dateFormatMark</em> are replaced by <strong>collection</strong> <em>spec</em></li>
    </ul>
  </li>
  <li><strong>fmrcInventory</strong> and <strong>addTimeCoverage</strong> elements are no longer needed</li>
</ol>
<p>New way:</p>
<pre>   &lt;<strong>featureCollection</strong> name=&quot;NCEP-GFS-CONUS_80km&quot; <strong>featureType=&quot;FMRC&quot;</strong> harvest=&quot;true&quot; path=&quot;fmrc/NCEP/GFS/CONUS_80km&quot;&gt;
     &lt;metadata inherited=&quot;true&quot;&gt;
       &lt;documentation type=&quot;summary&quot;&gt;good stuff&lt;/documentation&gt;
     &lt;/metadata&gt;&lt;/metadata&gt;
  
1)   &lt;collection spec=&quot;/data/ldm/pub/native/grid/NCEP/GFS/CONUS_80km/GFS_CONUS_80km_#yyyyMMdd_HHmm#.grib1&quot;
               <strong>recheckAfter</strong>=&quot;15 min&quot;
               <strong>olderThan</strong>=&quot;5 min&quot;/&gt;
2)   &lt;update startup=&quot;true&quot; rescan=&quot;0 5 3 * * ? *&quot; /&gt;
3)   &lt;protoDataset choice=&quot;Penultimate&quot; change=&quot;0 2 3 * * ? *&quot; /&gt;
4)   &lt;fmrcConfig regularize=&quot;true&quot; datasetTypes=&quot;TwoD Best Files Runs ConstantForecasts ConstantOffsets&quot; /&gt;
   &lt;/featureCollection&gt;
</pre>
<ol>
  <li><strong>collection spec </strong>element
    <ul>
      <li><strong>collection</strong> <em>recheckAfter</em> is the same as <strong>aggregation</strong> <em>recheckEvery</em> </li>
      <li><strong>collection </strong><em>olderThan</em> is the same as <strong>scan </strong><em>olderThan</em></li>
    </ul>
  </li>
  <li><strong>update</strong> (optional) allows control over when the <strong>featureCollection</strong>  is updated</li>
  <li><strong>protoDataset</strong> (optional) allows control over  the selection of the &quot;prototypical&quot; dataset</li>
  <li><strong>fmrcConfig</strong> (optional) allows control over which FMRC virtual datasets are made available</li>
</ol>
</body>
</html>
