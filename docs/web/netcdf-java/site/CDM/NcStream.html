<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>ncstream</title>
</head>

<body>
<h1>NetCDF Streaming Format (Experimental)</h1>
<hr width="100%" />
<h3>Overview</h3>
<p>NetCDF Streaming Format (ncstream) is a write-optimized  encoding of CDM datasets. Ncstream consistes of a series of header and data messages, in any order. Writes are always appended. Later messages override earlier ones whenever they overlap or conflict. To add or modify structural metadata, simply append a new header message. Each data message identifies the variable and the section (rectangular subset) of data it contains. A variable's data thus consists of the collection of data messages for it, if any.</p>
<h3> Design Goals</h3>
<ul>
  <li>Experiment with our own on-the-wire protocol to rapidly explore new ideas for remote data access.</li>
  <li>Experiment with ways to optimize subset extraction of large datasets, especially for the case when the subset is specified in coordinate space rather than index space.</li>
  <li>Must be easy to read ncstream and write netCDF-3 or netCDF-4 files.</li>
  <li>The information content / data model of ncstream is identical to CDM. So ncstream is an alternate encoding of CDM datasets.</li>
</ul>
<h3>Possible uses</h3>
<ul>
  <li>Study  OPeNDAP implementation. The java implementation of ncsteam should be (close to) maximal I/O efficient. By comparing the same requests on the same server to OPeNDAP, we should be able to tell how much speedup a rewrite of the OPeNDAP software will yeild.</li>
  <li>Augment/explore OPeNDAP. Where the DAP protocol is deficient, ncstream is a way for us to explore possible solutions. </li>
  <li>Augment/explore WCS. We are setting up experimental data services on motherlode that allow coordinate subsetting on Feature datasets. We can use ncstream to get these services working,  offering much the same functionality as  WCS. Impementing WCS services are then much easier to develop. Experience using ncstream can potentially be fed into WCS standards. This work has already been going on under the name of &quot;NetCDF Subset Service&quot;, and ncstream  will be offered as one of the output types.</li>
  <li>Explore asynchronous data services. Both OPeNDAP and WCS want asynchronous data services, for the case when requested data cannot be immediately returned, for example because of extensive computation or because the data resides in a tape silo. We can  explore possible solutions by having our own remote access protocol.</li>
  <li>Explore alternate file format for CDM datasets. Certain applications may need some of the extended features of CDM / Netcdf-4, without needing all of the complexity of the HDF5 format. Ncstream may comprise a &quot;sweet spot&quot; of functionality for some use cases. </li>
  <li>Parellel I/O. Append-only file writing may be useful in some high performance applications, with a second pass (external to the generating program) that efficiently converts to netCDF-3 or netCDF-4 files. During that conversion, a smart program could decide on chunking parameters, data-dependent compression choices, and other read optimizations.</li>
</ul>
<h3>Implementation</h3>
<p>Messages are encoded using Google's <a href="http://code.google.com/p/protobuf/">Protobuf</a> library.</p>
<blockquote>
  <p>&quot;Protocol buffers are a flexible, efficient, automated mechanism for  serializing structured data â€“ think XML, but smaller, faster, and  simpler. You define how you want your data to be structured once, then  you can use special generated source code to easily write and read your  structured data to and from a variety of data streams and using a  variety of languages. You can even update your data structure without  breaking deployed programs that are compiled against the &quot;old&quot; format.&quot;</p>
</blockquote>
<p>The main advantage of protobuf over XML is performance, since both message size and parsing speed is improved. A very important feature of protobuf is the ability to evolve the message structure in a way that doesnt break previous code.</p>
<p>We dont use protobuf messages for the data, since protobuf messages are built in memory, and we need to be able to stream (write data directly from its source onto the output stream, eg socket). The data is simply linearized in the usual netCDF way, and written to the stream. A data message identifying the variable and the section that the data represents is part of every data message. Probably we will use &quot;reader makes right&quot; byte order.</p>
<p>TDS 4.0 currently has  a prototype service using ncstream similar to OPeNDAP, which  can be used by Netcdf-Java 4.0 library. The classic model has been tested, and the extended model  processing is mostly complete. </p>
<h3>Grammer</h3>
<pre>   stream = MAGIC_HEADER, {message}
   message = headerMessage | dataMessage
   headerMessage = MAGIC_HEADER, vlen, NcStreamProto.Header
   dataMessage = MAGIC_DATA, vlen, NcStreamProto.Data, vlen, data
   
   vlen = variable length encoded positive integer
   NcStreamProto.Header = Header message encoded by protobuf
   NcStreamProto.Data = Data message encoded by protobuf

   MAGIC_START = 0x43, 0x44, 0x46, 0x53 // 'CDFS'
   MAGIC_HEADER= 0xad, 0xec,  0xce, 0xda 
   MAGIC_DATA =  0xab, 0xec,  0xce,  0xba 
 </pre>
<h3>NcStream.proto</h3>
<p>The following defines the grammer that the protobuf compiler uses to generate Java, C++, or Python source code.</p>
<pre>
package test;

option java_package = "ucar.nc2.stream";
option java_outer_classname = "NcStreamProto";

message Attribute {
  required string name = 1;
  enum Type {
    STRING = 0;
    BYTE = 1;
    SHORT = 2;
    INT = 3;
    LONG = 4;
    FLOAT = 5;
    DOUBLE = 6;
  }
  required Type type = 2;
  required uint32 len = 3;
  required bytes data = 4;
}

message Dimension {
  optional string name = 1;
  optional uint32 length = 2;
  optional bool isUnlimited = 3;
  optional bool isVlen = 4;
  optional bool isPrivate = 5;
}

enum DataType {
    CHAR = 0;
    BYTE = 1;
    SHORT = 2;
    INT = 3;
    LONG = 4;
    FLOAT = 5;
    DOUBLE = 6;
    STRING = 7;
    STRUCTURE = 8;
    SEQUENCE = 9;
}

message Variable {
  required string name = 1;
  required DataType dataType = 2;
  repeated Dimension shape = 3;
  repeated Attribute atts = 4;
  optional bytes data = 5;  // "immediate" - store small data in header
}

message Structure {
  required string name = 1;
  repeated Dimension shape = 2;
  required DataType dataType = 3;
  repeated Attribute atts = 4;
  repeated Variable vars = 5;
  repeated Structure structs = 6;
}

message Group {
  required string name = 1;
  repeated Dimension dims = 2;
  repeated Variable vars = 3;
  repeated Structure structs = 4;
  repeated Attribute atts = 5;
  repeated Group groups = 6;
}

message Header {
  required fixed64 indexPos = 1;
  optional string name = 2;
  required Group root = 3;
}

message Data {
  required string varName = 1;
  required DataType dataType = 2;
  required Section section = 3;
}

message Range {
  optional uint64 start = 1;
  required uint64 size = 2;
  optional uint64 stride = 3;
}

message Section {
  repeated Range range = 1;
}</pre>
<h3>Remote Netcdf Stream Service</h3>
<p>THREDDS ServiceType = NetcdfStream</p>
<h4>Examples:</h4>
<ul>
  <li>HEADER: http://localhost:8080/thredds/ncstream/stream/data.nc</li>
  <li>    DATA:   http://localhost:8080/thredds/ncstream/stream/data.nc?Temperature(0:0,0:127,0:163)</li>
</ul>
<h4>Notes:</h4>
<ul>
  <li>Data uses  Section specification, same as Fortran-90 array notation.</li>
  <li>    Variable name will need to be UTF8-escape encoded.<br />
  </li>
</ul>
<hr width="100%" />
<address>
<img src="../nc.gif" alt="" width="64" height="64" /> This document is maintained by <a href="mailto:caron@unidata.ucar.edu">John Caron</a> and was last updated on Feb 12, 2009
</address>
<p>&nbsp;</p>
</body>
</html>
