<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>ncstream</title></head>

<body>
<h1>NetCDF Streaming Format (Experimental)</h1>
<hr width="100%" />
<h3>Overview</h3>
<p>NetCDF Streaming Format (ncstream) is a write-optimized  encoding of CDM datasets. Ncstream consists of a series of header and data messages, in any order. Writes are always appended. Later messages override earlier ones whenever they overlap or conflict. To add or modify structural metadata, simply append a new header message. Each data message identifies the variable and the section (rectangular subset) of data it contains. A variable's data thus consists of the collection of data messages for it, if any.</p>
<h3> Design Goals</h3>
<ul>
  <li>Experiment with our own on-the-wire protocol to rapidly explore new ideas for remote data access.</li>
  <li>Experiment with ways to optimize subset extraction of large datasets, especially for the case when the subset is specified in coordinate space rather than index space.</li>
  <li>Must be easy to read ncstream and write netCDF-3 or netCDF-4 files.</li>
  <li>The information content / data model of ncstream is identical to CDM. So ncstream is an alternate encoding of CDM datasets.</li>
</ul>
<h3>Possible uses</h3>
<ul>
  <li>Study  OPeNDAP implementation. The java implementation of ncsteam should be (close to) maximal I/O efficient. By comparing the same requests on the same server to OPeNDAP, we should be able to tell how much speedup a rewrite of the OPeNDAP software will yeild.</li>
  <li>Augment/explore OPeNDAP. Where the DAP protocol is deficient, ncstream is a way for us to explore possible solutions. </li>
  <li>Augment/explore WCS. We are setting up experimental data services on motherlode that allow coordinate subsetting on Feature datasets. We can use ncstream to get these services working,  offering much the same functionality as  WCS. Implementing WCS services are then much easier to develop. Experience using ncstream can potentially be fed into WCS standards. This work has already been going on under the name of &quot;NetCDF Subset Service&quot;, and ncstream  will be offered as one of the output types.</li>
  <li>Explore asynchronous data services. Both OPeNDAP and WCS want asynchronous data services, for the case when requested data cannot be immediately returned, for example because of extensive computation or because the data resides in a tape silo. We can  explore possible solutions by having our own remote access protocol.</li>
  <li>Explore alternate file format for CDM datasets. Certain applications may need some of the extended features of CDM / Netcdf-4, without needing all of the complexity of the HDF5 format. Ncstream may comprise a &quot;sweet spot&quot; of functionality for some use cases. </li>
  <li>Parellel I/O. Append-only file writing may be useful in some high performance applications, with a second pass (external to the generating program) that efficiently converts to netCDF-3 or netCDF-4 files. During that conversion, a smart program could decide on chunking parameters, data-dependent compression choices, and other read optimizations.</li>
</ul>
<h3>Implementation</h3>
<p>Messages are encoded using Google's <a href="http://code.google.com/p/protobuf/">Protobuf</a> library.</p>
<blockquote>
  <p>&quot;Protocol buffers are a flexible, efficient, automated mechanism for  serializing structured data â€“ think XML, but smaller, faster, and  simpler. You define how you want your data to be structured once, then  you can use special generated source code to easily write and read your  structured data to and from a variety of data streams and using a  variety of languages. You can even update your data structure without  breaking deployed programs that are compiled against the &quot;old&quot; format.&quot;</p>
</blockquote>
<p>The main advantage of protobuf over XML is performance, since both message size and parsing speed is improved. A very important feature of protobuf is the ability to evolve the message structure in a way that doesnt break previous code.</p>
<p>We dont use protobuf messages for the data, since protobuf messages are built in memory, and we need to be able to stream (write data directly from its source onto the output stream, eg socket). The data is simply linearized in the usual netCDF way, and written to the stream. A data message identifying the variable and the section that the data represents is part of every data message. Probably we will use &quot;reader makes right&quot; byte order.</p>
<p>TDS 4.0 currently has  a prototype service using ncstream similar to OPeNDAP, which  can be used by Netcdf-Java 4.0 library. The classic model has been tested, and the extended model  processing is mostly complete. </p>
<h3>Grammer</h3>
<pre>   stream = MAGIC_HEADER, {message}
   message = headerMessage | dataMessage
   headerMessage = MAGIC_HEADER, vlen, NcStreamProto.Header
   dataMessage = MAGIC_DATA, vlen, NcStreamProto.Data, vlen, data
   
   vlen = variable length encoded positive integer
   NcStreamProto.Header = Header message encoded by protobuf
   NcStreamProto.Data = Data message encoded by protobuf

   MAGIC_START = 0x43, 0x44, 0x46, 0x53 // 'CDFS'
   MAGIC_HEADER= 0xad, 0xec,  0xce, 0xda 
   MAGIC_DATA =  0xab, 0xec,  0xce,  0xba 
 </pre>
<p>The messages are defined in </p>
<ul>
  <li><strong>thredds\cdm\src\main\java\ucar\nc2\stream\ncStream.proto</strong></li>
  <li><strong>thredds\cdm\src\main\java\ucar\nc2\ft\point\remote\pointStream.proto</strong><br>
  </li>
</ul>
<h2>&nbsp;</h2>
<h2>CdmRemote Web Service</h2>
<p>CdmRemote is an experimental web service implemented in the TDS, providing remote access to CDM datasets, using ncstream as the on-the-wire protocol. It provides access at the  NetcdfDataset, and Feature Type levels of the CDM, using   <strong>ServiceType.CdmRemote</strong></p>
<h3>NetcdfDataset (Data Access and Coordinate Systems)</h3>
<p>Datasets can be accessed in index space, similar to netCDF or OPeNDAP. The Coordinate Systems are created on the server, and passed to the client.</p>
<table width="831" border="1">
<tr>
        <th width="595" scope="col">Request</th>
    <th width="220" scope="col">Response</th>
  </tr>
      <tr>
        <td><p>
          http://server:8080/thredds/cdmremote/data.nc?<strong>view=CDL</strong>
        </p></td>
        <td> dataset CDL</td>
      </tr>
      <tr>
        <td>http://server:8080/thredds/cdmremote/data.nc?<strong>view=NcML</strong></td>
        <td>dataset NcML</td>
      </tr>
      <tr>
        <td>http://server:8080/thredds/cdmremote/data.nc?<strong>getCapabilities</strong></td>
        <td>capabilities XML</td>
      </tr>
      <tr>
        <td>http://server:8080/thredds/cdmremote/data.nc?<strong>header</strong></td>
        <td>header ncstream message, contains the structural metadata</td>
      </tr>
      <tr>
        <td>http://server:8080/thredds/cdmremote/data.nc?<strong>Temp(0:100:10,0:127,0:163),lat,lon</strong></td>
        <td>data ncstream message</td>
      </tr>
</table>

<ul>
  <li>Data request  uses Section specification (same as Fortran-90 array notation) to ask for a subset in index space.</li>
  <li> Variable names must be UTF8-escape encoded.</li>
  <li>GetCapabilities indicates which (if any) feature types the dataset can be opened as, along with the URLs of those services. TBD.</li>
</ul>
<h3>&nbsp;</h3>
<h3>FeatureType Dataset</h3>
<p>Datasets can be accessed in coordinate space, similar to the  Netcdf Subset Service, WCS and WMS. </p>
<h4>PointDataset</h4>
<table width="867" border="1">
  <tr>
    <th width="658" scope="col">Request</th>
    <th width="193" scope="col">Response</th>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/point?<strong>header</strong></td>
    <td>header ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/point?<strong>all</strong></td>
    <td>pointData ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/point?<strong>north=40.3&amp;south=22.8&amp;east=-80&amp;west=-105</strong></td>
    <td>pointData ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/point?<strong>bbox=-105,-80,22,40</strong></td>
    <td>pointData ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/point?<strong>time_start=&amp;time_end=</strong></td>
    <td>pointData ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/point?<strong>time=</strong></td>
    <td>pointData ncstream message</td>
  </tr>
</table>
<ul>
  <li>bbox same as WCS, whatever that is</li>
  <li>data requests return an unordered list of observation as StructureData</li>
</ul>
<h4>StationTimeSeries</h4>
<table width="961" border="1">
  <tr>
    <th width="741" scope="col">Request</th>
    <th width="204" scope="col">Response</th>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/station?<strong>header</strong></td>
    <td>header ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/station?<strong>stations</strong></td>
    <td>stationList ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/station?<strong>stations&amp;north=40.3&amp;south=22.8&amp;east=-80&amp;west=-105</strong></td>
    <td>stationList ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/station?<strong>time_start=&amp;time_end=</strong></td>
    <td>pointData ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/station?<strong>time=</strong></td>
    <td>pointData ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/station?<strong>stations&amp;north=40.3&amp;south=22.8&amp;east=-80&amp;west=-105</strong></td>
    <td>stationList ncstream message</td>
  </tr>
  <tr>
    <td>http://server:8080/thredds/cdmremote/data.nc/station?<strong>stn=KDEN,KLOG,MOAS</strong></td>
    <td>pointData ncstream message</td>
  </tr>
</table>
<ul>
  <li>data requests return an unordered list of observation as StructureData</li>
</ul>
<p><br />
</p>
<hr width="100%" />
<address>
<img src="../nc.gif" alt="" width="64" height="64" /> This document is maintained by <a href="mailto:caron@unidata.ucar.edu">John Caron</a> and was last updated on May 28, 2009
</address>
<p>&nbsp;</p>
</body>
</html>
