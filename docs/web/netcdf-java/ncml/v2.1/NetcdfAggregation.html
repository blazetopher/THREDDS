<html>
<head>
<title>Aggregating netCDF files with netCDF Datasets</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
</head>

<body bgcolor="#FFFFFF" text="#000000">
<h1>Aggregating netCDF files with netCDF Datasets (version 2)</h1>
<p><i>John Caron</i></p>
<p><i>last changed: Sep 05, 2003</i></p>
<hr>
<h2>Introduction</h2>
<p><a href="NetcdfDataset.html">Netcdf Datasets</a> allow multiple netCDF files 
  to be logically grouped together. This is done with nested netcdf elements in 
  the NetCDF Dataset Definition XML document. You must be sure to use the schema 
  location <em><strong>http://www.unidata.ucar.edu/schemas/netcdfDataset2.xsd</strong><strong> 
  </strong></em>in order to distinguish from the older, &quot;version 1&quot; 
  of the NcML Dataset specification.</p>
<h3>Example: Union of netCDF files</h3>
<p>The following constructs a dataset by creating the union of two netCDF files:</p>
<pre>&lt;netcdf xmlns='http://www.ucar.edu/schemas/netcdf'<br>    xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'<br>    xsi:schemaLocation='http://www.ucar.edu/schemas/netcdf http://www.unidata.ucar.edu/schemas/netcdfDataset2.xsd' <br>
  &lt;netcdf uri=&quot;http://host/path/rh.nc&quot;&gt;     
    &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt; 
    &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;   
    &lt;dimension name=&quot;time&quot; length=&quot;12&quot; /&gt; 
    &lt;variable name=&quot;rh&quot; type=&quot;float&quot; shape=&quot;time lat lon&quot;/&gt;   
  &lt;/netcdf&gt; 
   
  &lt;netcdf uri=&quot;http://host/path/temp.nc&quot;&gt;     
    &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt; 
    &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;   
    &lt;dimension name=&quot;time&quot; length=&quot;12&quot; /&gt; 
    &lt;variable name=&quot;Temperature&quot; type=&quot;float&quot; shape=&quot;time lat lon&quot;/&gt;   
  &lt;/netcdf&gt; 

&lt;/netcdf&gt; </pre>
<p>The resulting dataset looks like:</p>
<pre>
netcdf file:///E:/dev/NCdataset/xml/TestUnion.xml {
 dimensions:
  time = 12;   
  lat = 64;   
  lon = 128; 


 variables:  
  float rh(time, lat, lon);  
  float Temperature(time, lat, lon);
 }</pre>
<p>The <b>rh</b> variable will be read from <i>http://host/path/rh.nc</i>, while 
  the <b>Temperature</b> variable will be read from <i>http://host/path/temp.nc. 
  </i>Note that there is no <i>uri</i> attribute in the outer netcdf element. 
  The dimensions in the nested files with the same names must have the same lengths. 
  If they did not, you would need to rename one of them.</p>
<h3>Netcdf containers</h3>
<p>All of the elements of a nested netcdf element are copied into the parent netcdf 
  element, unless the element already exists there. Therefore, <i> <b>the contents 
  of a netcdf element are the union of its own elements, and the contents of its 
  children netcdf elements (if any). </b></i>Netcdf elements are really containers 
  for the other elements (dimension, attribute, or variable), so we will use the 
  phrase <i>netcdf container</i> in the context of nested netcdf elements.</p>
<p>When an element with the same name and type (dimension, attribute, or variable) 
  appears in multiple places, one of them takes precedence within a particular 
  netcdf container. The rules are: </p>
<ol>
  <ol>
    <li>An element that is directly contained in a netcdf element overrides one 
      that is in a child.</li>
    <li>When two element appear at the same child level, the first one to appear 
      is used in the parent. </li>
  </ol>
</ol>
<h3> Aggregation on an existing dimension</h3>
<p>The following constructs a dataset by declaring &quot;time&quot; an <em>aggregation 
  dimension</em>. Any variable that uses that dimension is an <i>aggregation variable</i>. 
  The dimension must be the rightmost (slowest varying) dimension. </p>
<pre>&lt;netcdf&gt;<br>  &lt;aggregation dimName=&quot;time&quot; type=&quot;joinExisting&quot;/&gt; 

  &lt;netcdf uri=&quot;file://test/temperature/jan.nc&quot;&gt;
    &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt; <br>    &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
    &lt;dimension name=&quot;time&quot; length=&quot;31&quot; /&gt;
    &lt;variable name=&quot;T&quot; type=&quot;float&quot; shape=&quot;time lat lon&quot;/&gt;
  &lt;/netcdf&gt;

  &lt;netcdf uri=&quot;file://test/temperature/feb.nc&quot;&gt;
    &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt; <br>    &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
    &lt;dimension name=&quot;time&quot; length=&quot;28&quot; /&gt;
    &lt;variable name=&quot;T&quot; type=&quot;float&quot; shape=&quot;time lat lon&quot;/&gt;
  &lt;/netcdf&gt;
<br>&lt;/netcdf&gt;
</pre>
<p> The aggregation element declares a dimension element, along with any nested 
  variables that use that dimension. Therefore the above is equivalent to:</p>
<pre>
&lt;netcdf&gt;<br>  &lt;dimension name=&quot;time&quot; length=&quot;59&quot; /&gt;
  &lt;variable name=&quot;T&quot; type=&quot;float&quot; shape=&quot;time lat lon&quot;/&gt;

  &lt;netcdf uri=&quot;file://test/temperature/jan.nc&quot;&gt;
    &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt; <br>    &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
    &lt;dimension name=&quot;time&quot; length=&quot;31&quot; /&gt;
    &lt;variable name=&quot;T&quot; type=&quot;float&quot; shape=&quot;time lat lon&quot;/&gt;
  &lt;/netcdf&gt;

  &lt;netcdf uri=&quot;file://test/temperature/feb.nc&quot;&gt;
    &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt; <br>    &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
    &lt;dimension name=&quot;time&quot; length=&quot;28&quot; /&gt;
    &lt;variable name=&quot;T&quot; type=&quot;float&quot; shape=&quot;time lat lon&quot;/&gt;
  &lt;/netcdf&gt;
<br>&lt;/netcdf&gt;</pre>
<p>where the variable <b>T</b> is an aggregation variable with the first (0:31, 
  0:63, 0:127) data values taken from the file <i>jan.nc</i> and the next (32:58, 
  0:63, 0:127) data values are taken from <i>feb.nc</i>. A client reading this 
  dataset will not know any of this, and will just access it through the usual 
  netCDF API. The dataset CDL will look like this to the client:</p>
<pre>netcdf file:///E:/dev/NCdataset/xml/aggExisting.xml {<br> dimensions:<br>  lat = 64;<br>  lon = 128;<br>  time = 59;
 variables:
  float T(time, lat, lon);
}</pre>
<p>It is common to use the <strong><em>readMetadata</em></strong> element in aggregations, 
  so the following is equivalent:</p>
<pre>&lt;netcdf&gt;
  &lt;aggregation dimName=&quot;time&quot; type=&quot;joinExisting&quot;/&gt; 

  &lt;netcdf uri=&quot;file://test/temperature/jan.nc&quot;&gt;
    &lt;readMetadata /&gt;
  &lt;/netcdf&gt;

  &lt;netcdf uri=&quot;file://test/temperature/feb.nc&quot;&gt;
   &lt;readMetadata /&gt;
  &lt;/netcdf&gt;
<br>&lt;/netcdf&gt;</pre>
<p>In fact, when a nested netcdf element appears with no child element, the &lt;readMetadata 
  /&gt; is assumed, so you can abbreviate the above as:</p>
<pre>&lt;netcdf&gt;
  &lt;aggregation dimName=&quot;time&quot; type=&quot;joinExisting&quot;/&gt; 

  &lt;netcdf uri=&quot;file://test/temperature/jan.nc&quot; /&gt;
  &lt;netcdf uri=&quot;file://test/temperature/feb.nc&quot; /&gt;<br>&lt;/netcdf&gt;</pre>
<h3>Variable Aggregation on a synthetic dimension</h3>
<p>The previous example &quot;joined&quot; variables along their existing outer 
  dimension. Another common case is to aggregate variables by creating a new outer 
  dimension. Each existing variable becomes one &quot;slice&quot; of the compound 
  variable (a <i>slice</i> holds the index of one dimension constant, e.g. <b>humidity(3, 
  *, *, *)</b>). The following joins variables from three separate files into 
  a single variable, by creating a new dimension of length 3:</p>
<pre>&lt;netcdf&gt;<br>  &lt;aggregation dimName=&quot;time&quot; type=&quot;joinNew&quot;&gt;
    &lt;variableAgg name=&quot;T&quot;/&gt;
    &lt;variableAgg name=&quot;P&quot;/&gt;
  &lt;/aggregation&gt;
<br> &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time1.nc&quot;&gt;
   &lt;dimension name=&quot;lat&quot; length=&quot;64&quot;/&gt;<br>   &lt;dimension name=&quot;lon&quot; length=&quot;128&quot;/&gt;
   &lt;variable name=&quot;T&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;<br>   &lt;variable name=&quot;P&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;<br> &lt;/netcdf&gt;<br><br> &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time2.nc&quot;&gt;<br>   &lt;dimension name=&quot;lat&quot; length=&quot;64&quot;/&gt;<br>   &lt;dimension name=&quot;lon&quot; length=&quot;128&quot;/&gt;
   &lt;variable name=&quot;T&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;
   &lt;variable name=&quot;P&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;<br> &lt;/netcdf&gt;<br>
 &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time3.nc&quot;&gt;<br>   &lt;dimension name=&quot;lat&quot; length=&quot;64&quot;/&gt;<br>   &lt;dimension name=&quot;lon&quot; length=&quot;128&quot;/&gt;
   &lt;variable name=&quot;T&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;
   &lt;variable name=&quot;P&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;<br> &lt;/netcdf&gt;<br>
&lt;/netcdf&gt;</pre>
<p>For this kind of aggregation, you must explicitly declare which nested variables 
  are to be aggregated in the variableAgg elements. The size of the new dimension 
  will be the number of nested files. The above is equivalent to the following 
  declaration:</p>
<pre>&lt;netcdf&gt;<br>  &lt;dimension name=&quot;time&quot; length=&quot;3&quot;/&gt;
  &lt;variable name=&quot;T&quot; type=&quot;double&quot; shape=&quot;time lat lon&quot;/&gt;<br>  &lt;variable name=&quot;P&quot; type=&quot;double&quot; shape=&quot;time lat lon&quot;/&gt;<br><br> &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time1.nc&quot;&gt;
   &lt;dimension name=&quot;lat&quot; length=&quot;64&quot;/&gt;<br>   &lt;dimension name=&quot;lon&quot; length=&quot;128&quot;/&gt;
   &lt;variable name=&quot;T&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;<br>   &lt;variable name=&quot;P&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;<br> &lt;/netcdf&gt;<br><br> &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time2.nc&quot;&gt;<br>   &lt;dimension name=&quot;lat&quot; length=&quot;64&quot;/&gt;<br>   &lt;dimension name=&quot;lon&quot; length=&quot;128&quot;/&gt;
   &lt;variable name=&quot;T&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;
   &lt;variable name=&quot;P&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;<br> &lt;/netcdf&gt;<br>
 &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time3.nc&quot;&gt;<br>   &lt;dimension name=&quot;lat&quot; length=&quot;64&quot;/&gt;<br>   &lt;dimension name=&quot;lon&quot; length=&quot;128&quot;/&gt;
   &lt;variable name=&quot;T&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;
   &lt;variable name=&quot;P&quot; type=&quot;double&quot; shape=&quot;lat lon&quot;/&gt;<br> &lt;/netcdf&gt;<br>
&lt;/netcdf&gt;</pre>
<p>where <strong>T</strong> an <strong>P</strong> are aggregation variables whose 
  data values are taken from the corresponding variables in the nested netcdf 
  datasets.</p>
<p>The outer level dataset has this CDL:</p>
<pre>
netcdf file:///E:/dev/NCdataset/xml/aggType1.xml {<br> dimensions:<br>  lat = 64;<br>  lon = 128;<br>  time = 3;   // (has coord.var)<br>  time_len = 20;
 variables:<br>  float T(time, lat, lon);<br>  char time(time, time_len);

data:
  time = &quot;2000-7-16 6:00&quot;, &quot;2000-8-16 6:00&quot;, &quot;2000-9-16 6:00&quot;;
}
</pre>
<p> Here is the same aggregation, but using the implied &lt;readMetadata/&gt; 
  element, and adding a coordinate variable for the new dimension. Note that you 
  do not have to specify the <em><strong>npts</strong></em> atttibute on the <em><strong>values</strong></em> 
  element in the <em><strong>time</strong></em> variable declaration:</p>
<pre>
&lt;netcdf&gt;
  &lt;variable name=&quot;time&quot; type=&quot;int&quot; shape=&quot;time&quot;&gt;<br>    &lt;attribute name=&quot;long_name&quot; type=&quot;string&quot; value=&quot;time coordinate&quot; /&gt;<br>    &lt;attribute name=&quot;units&quot; type=&quot;string&quot; value=&quot;days since 2001-8-31 00:00:00 UTC&quot; /&gt;<br>    &lt;values start=&quot;0&quot; increment=&quot;1&quot; /&gt;<br>  &lt;/variable&gt;<br>
 &lt;aggregation dimName=&quot;time&quot; type=&quot;joinNew&quot;&gt;
    &lt;variableAgg name=&quot;T&quot;/&gt;
    &lt;variableAgg name=&quot;P&quot;/&gt;
  &lt;/aggregation&gt;
<br> &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time1.nc&quot; /&gt;
 &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time2.nc&quot; /&gt;<br> &lt;netcdf uri=&quot;file:///E:/dev/NCdataset/data/time3.nc&quot; /&gt;<br>&lt;/netcdf&gt;<br>
</pre>
<h3>Example: double nested netcdf elements</h3>
<p>This defines the union of two variables which share the time coordinate, and 
  each of which consists of a time series aggregation along an existing dimension. 
</p>
<pre>&lt;netcdf&gt;

  &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt;
  &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
  &lt;dimension name=&quot;time&quot; length=&quot;59&quot;/&gt; 
  
  &lt;netcdf&gt;
    &lt;aggregation dimName=&quot;time&quot; type=&quot;joinExisting&quot;/&gt;

    &lt;netcdf uri=&quot;file:///data/T/jan.nc&quot;&gt;
      &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt;
      &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
      &lt;dimension name=&quot;time&quot; length=&quot;31&quot; /&gt;
      &lt;variable name=&quot;Temperature&quot; type=&quot;double&quot; shape=&quot;time lat lon&quot;/&gt;
      &lt;variable name=&quot;time&quot; type=&quot;int&quot; shape=&quot;time&quot;/&gt;
    &lt;/netcdf&gt;

    &lt;netcdf uri=&quot;file:///data/T/feb.nc&quot;&gt;
      &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt;
      &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
      &lt;dimension name=&quot;time&quot; length=&quot;28&quot; /&gt;    
      &lt;variable name=&quot;Temperature&quot; type=&quot;double&quot; shape=&quot;time lat lon&quot;/&gt;
      &lt;variable name=&quot;time&quot; type=&quot;int&quot; shape=&quot;time&quot;/&gt;
    &lt;/netcdf&gt;
    
  &lt;/netcdf&gt;

  &lt;netcdf&gt;
    &lt;aggregation dimName=&quot;time&quot; type=&quot;joinExisting&quot;/&gt;

    &lt;netcdf uri=&quot;file:///data/P/jan.nc&quot;&gt;
      &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt;
      &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
      &lt;dimension name=&quot;time&quot; length=&quot;31&quot; /&gt;
      &lt;variable name=&quot;Pressure&quot; type=&quot;double&quot; shape=&quot;time lat lon&quot;/&gt;
      &lt;variable name=&quot;time&quot; type=&quot;int&quot; shape=&quot;time&quot;/&gt;
    &lt;/netcdf&gt;

    &lt;netcdf uri=&quot;file:///data/P/feb.nc&quot;&gt;
      &lt;dimension name=&quot;lat&quot; length=&quot;64&quot; /&gt;
      &lt;dimension name=&quot;lon&quot; length=&quot;128&quot; /&gt;
      &lt;dimension name=&quot;time&quot; length=&quot;28&quot; /&gt;    
      &lt;variable name=&quot;Pressure&quot; type=&quot;double&quot; shape=&quot;time lat lon&quot;/&gt;
      &lt;variable name=&quot;time&quot; type=&quot;int&quot; shape=&quot;time&quot;/&gt;
    &lt;/netcdf&gt;
   &lt;/netcdf&gt;
  
&lt;/netcdf&gt;
</pre>
<p>This creates the following Dataset in CDL:</p>
<pre>netcdf file:///E:/dev/NCdataset/xml/doubleNested.xml {<br> dimensions:<br>  lat = 64;<br>  lon = 128;<br>  time = 59;   // (has coord.var)
 variables:<br>  int time(time);<br>  float Pressure(time, lat, lon);<br>  float Temperature(time, lat, lon);
}
</pre>
<h3>Example NcML Aggregation XML files</h3>
<ol>
  <li>A simple <a href="examples/dataset/aggUnion.xml">Union</a> of 2 netCDF files, 
    with all the metadata specified in the NcML. </li>
  <li>Example of a <a href="examples/dataset/cwindAgg.xml">JoinExisting</a> aggregation, 
    adding a coordinate variable.</li>
  <li>You can use NcML datasets in a <a href="http://www.unidata.ucar.edu/projects/THREDDS/tech/aggServer/AggServerStatus.html">DODS 
    Netcdf/Aggregation server</a> (aka AS). Here is an example of using the above 
    JoinExisting NcML dataset in an AS <a href="examples/dataset/ASconfig.xml">configuration 
    file</a>. The aggregation is done by NcML instead of the AS. The AS just serves 
    it out as if it were a netCDF file.</li>
</ol>
<p>&nbsp;</p>
</body>
</html>
